# Шаблон для парсингу документів через AI

## === ІНСТРУКЦІЇ ДЛЯ ПАРСИНГУ ===

**Завдання:** Розпізнай документ і поверни дані суворо у форматі JSON.

**КРИТИЧНО ВАЖЛИВО:**

### Постачальник vs Покупець
- **Постачальник (vendor)** - ХТО ПРОДАЄ / ХТО ВИСТАВИВ РАХУНОК
- У рахунках це зазвичай перше поле "Постачальник:" або "Продавець:"
- Якщо написано "Постачальник: ТОВ КОМПАНІЯ" — це і є vendor
- НЕ плутай з покупцем (це може бути твоя компанія)

### Таблиця товарів
- Кожен рядок = одна позиція
- **Колонки можуть бути в різному порядку:** №, Товар, Кількість, Од., Ціна без ПДВ, ПДВ, Сума
- **Quantity** і **Unit** — це ОКРЕМІ КОЛОНКИ після назви товару:
  - Структура: № | Товар | Кількість | Од. | Ціна | Сума
  - Приклад: "1 | Лист н/ж 201 0,8 | 79,36 | кг | 75,52 | 1198,65"
  - Quantity = 79.36 (число з колонки "Кількість")
  - Unit = "кг" (з колонки "Од.")
  - НЕ бери quantity з назви товару! Цифри в назві - це характеристики (товщина, розмір)
- **НЕ плутай:**
  - ✅ Правильно: quantity=79.36, name="Лист н/ж 201 0,8"
  - ❌ Неправильно: quantity=0.8 (це товщина, а не кількість!)
- **Name** — це назва товару БЕЗ кількості та одиниць (але З характеристиками)
- Шукай колонку "Кіл-сть" або "Кількість" - там реальна кількість товару!

### ВАЖЛИВО: Якщо текст неформатований (OCR зміщений)
**Коли колонки зміщені або зіпсовані, дотримуйся цього алгоритму:**

1. **Знайди заголовки таблиці** (зазвичай є рядок з назвами колонок)
   - Шукай слова: "Товари", "Кількість", "Ціна", "Сума", "Од."
   
2. **Для кожної позиції збирай всі числа після назви товару:**
   - Перше число ≥1 з одиницею (м, шт, кг) → це **quantity** і **unit**
   - Число з комою/крапкою від 10 до 10000 → ймовірно **price_unit**
   - Найбільше число → ймовірно **price_subtotal**

3. **ПЕРЕВІР математику для кожного рядка:**
   ```
   price_subtotal = quantity × price_unit
   ```
   - Якщо НЕ збігається — шукай правильні числа заново!
   - Приклад: quantity=50, price_unit=57.50 → price_subtotal має бути 2875.00 (а не 2500!)

4. **Використай підсумки для валідації:**
   - Сума всіх price_subtotal МАЄ дорівнювати "Разом без ПДВ" з документа
   - Якщо не збігається — перевір усі числа ще раз!

5. **Якщо є сумнів між двома числами:**
   - Завжди обирай те, що дає правильну математику
   - Перевіряй з підсумками документа

### VAT (ПДВ)
- Якщо ставка не вказана явно, обчисли її математично
- Якщо різниця між ціною з ПДВ та без ПДВ ≈ 20%, став `tax_percent: 20`
- Інакше `tax_percent: 0`

### Суми в header
- **amount_untaxed** — це "Разом:" або "Сума без ПДВ" (найбільше число перед податком)
- **amount_tax** — це "Сума ПДВ:" або "ПДВ"
- **amount_total** — це "Разом до сплати:" або "Всього до сплати"
- ЦІ ПОЛЯ ОБОВ'ЯЗКОВІ! Шукай їх в кінці документа

### Units (Одиниці виміру)
- НЕ конвертуй одиниці виміру
- Залишай ТОЧНО як в документі: "шт", "кг", "м", "100 шт", "послуга" тощо
- НЕ видаляй числа якщо вони частина одиниці: "100 шт" залишається "100 шт"

### Cleaning (Очищення)
- Видаляй спецсимволи (X/, *, #) з артикулів
- Очищай коди УКТ ЗЕД (тільки цифри, без пробілів)
- Видаляй зайві пробіли з назв товарів

### Розрахунки
- Якщо ціна без ПДВ не вказана, розрахуй: `price_unit = price_total / (1 + tax_percent/100)`
- Якщо сума без ПДВ не вказана, розрахуй: `price_subtotal = price_unit * quantity`
- Завжди перевіряй: `price_total = price_subtotal * (1 + tax_percent/100)`

### МАТЕМАТИЧНА ПЕРЕВІРКА (обов'язкова!)
**Після парсингу всіх позицій ОБОВ'ЯЗКОВО перевір суми:**

1. **Спочатку розрахуй price_total для кожного рядка:**
   - Якщо є price_subtotal і tax_percent: `price_total = price_subtotal × (1 + tax_percent/100)`
   - Приклад: price_subtotal=1198.65, tax_percent=20 → price_total = 1198.65 × 1.20 = 1438.38
   - Заокругли до 2 знаків

2. **amount_untaxed** (header) = Σ price_subtotal (всіх рядків)
   - Розрахуй суму всіх price_subtotal
   - Порівняй з "Разом:" або "Сума без ПДВ" в документі
   - Використай розраховане значення

3. **amount_tax** (header) = Σ (price_total - price_subtotal) (всіх рядків)
   - Розрахуй: amount_total - amount_untaxed
   - Порівняй з "Сума ПДВ:" в документі
   - Використай розраховане значення

4. **amount_total** (header) = Σ price_total (всіх рядків)
   - Розрахуй суму всіх price_total
   - Порівняй з "Разом до сплати:" в документі
   - Використай значення з документа якщо воно є

5. **Фінальна перевірка:** amount_total = amount_untaxed + amount_tax
   - Якщо не збігається — перерахуй все ще раз

**Якщо суми не збігаються:**
- Перевір чи всі рядки додані
- Перевір округлення (зазвичай до 2 знаків після коми)
- Використай розраховані значення замість тих що в документі (можуть бути помилки)

**ВАЖЛИВО:** price_total для КОЖНОГО рядка має бути price_subtotal × (1 + tax_percent/100)!

### МФО банку
- Якщо МФО не вказано явно, витягни з символів 5-10 IBAN
- Формат IBAN: `UA` + 2 цифри (контрольні) + 6 цифр (МФО) + решта
- Приклад: UA293005280000026007001353870 → МФО = 300528
- Якщо не можеш визначити — поверни `null`

### Терміни оплати
- Якщо вказано "5 днів з дати виписки" — розрахуй дату: `doc_date + 5 днів`
- Якщо термін не вказаний — поверни `null`

---

## === JSON SCHEMA ===

```json
{
  "header": {
    // === ЗАГАЛЬНА ІНФОРМАЦІЯ ПРО ДОКУМЕНТ ===
    "doc_type": "string | null - Тип документа: 'Видаткова накладна', 'Рахунок', 'Акт' тощо",
    "doc_number": "string | null - Номер документа (як в оригіналі)",
    "doc_date": "string | null - Дата документа у форматі YYYY-MM-DD",
    
    // === ДАНІ ПОСТАЧАЛЬНИКА ===
    "vendor_name": "string | null - Повна юридична назва постачальника",
    "vendor_edrpou": "string | null - Код ЄДРПОУ (тільки 8 або 10 цифр)",
    "vendor_ipn": "string | null - ІПН постачальника (тільки цифри)",
    "vendor_address": "string | null - Повна адреса постачальника",
    "vendor_phone": "string | null - Телефони постачальника",
    "tax_system": "string | null - Статус платника податків (напр. 'Загальна система', 'Спрощена система', 'ПДВ')",
    
    // === БАНКІВСЬКІ РЕКВІЗИТИ ПОСТАЧАЛЬНИКА ===
    "vendor_iban": "string | null - Номер рахунку у форматі UAxxxxxxxxxxxxxxxxxx (28 символів)",
    "vendor_bank": "string | null - Повна назва банку постачальника",
    "vendor_bank_city": "string | null - Місто банку постачальника",
    "vendor_mfo": "string | null - МФО банку (6 цифр). Витягни з позицій 5-10 IBAN або залиш null",
    
    // === СУМИ ДОКУМЕНТА ===
    "currency": "string - Валюта документа (за замовчуванням 'UAH')",
    "amount_untaxed": "number - Загальна сума БЕЗ ПДВ (сума всіх price_subtotal)",
    "amount_tax": "number - Сума ПДВ (різниця між amount_total та amount_untaxed)",
    "amount_total": "number - Повна сума ДО СПЛАТИ (з ПДВ)",
    "due_date": "string | null - Дата оплати у форматі YYYY-MM-DD (розрахуй, якщо вказано термін у днях)"
  },
  
  "lines": [
    {
      // === БАЗОВА ІНФОРМАЦІЯ ПРО ПОЗИЦІЮ ===
      "line_number": "integer - Порядковий номер рядка (1, 2, 3...)",
      "name": "string - Назва товару/послуги (очищена від зайвих пробілів, артикулів та штрихкодів)",
      
      // === КІЛЬКІСТЬ ТА ОДИНИЦІ ===
      "quantity": "number - Кількість (формат: 0.000)",
      "unit": "string - Оригінальна одиниця виміру з документа ('шт', '100 шт', 'грн', 'м.п', 'послуга' тощо)",
      
      // === ЦІНИ ТА СУМИ ===
      "price_unit": "number - Ціна за одиницю БЕЗ ПДВ (формат: 0.00). Якщо не дано - розрахуй",
      "tax_percent": "integer - Ставка ПДВ: 0 або 20 (визнач математично за різницею цін)",
      "price_subtotal": "number - Сума рядка БЕЗ ПДВ (формат: 0.00). Якщо не дано - розрахуй",
      "price_total": "number - Сума рядка З ПДВ (формат: 0.00). Якщо не дано - розрахуй",
      
      // === ДОДАТКОВІ ІДЕНТИФІКАТОРИ ===
      "article": "string | null - Артикул виробника (очищений від спецсимволів)",
      "ukt_zed": "string | null - Код УКТ ЗЕД (тільки цифри, без роздільників)",
      "barcodes": "array - Масив всіх штрихкодів для цієї позиції (або порожній масив [])"
    }
  ],
  
  "metadata": {
    "source": "string | null - Ім'я файлу або джерело документа",
    "origin_invoice": "string | null - Номер документа-підстави (якщо є посилання на інший документ)"
  }
}
```

---

## === ПРИКЛАД ВІДПОВІДІ ===

**Приклад 1: Добре форматований документ**

```json
{
  "header": {
    "doc_type": "Видаткова накладна",
    "doc_number": "ВН-2024-00123",
    "doc_date": "2024-01-15",
    "vendor_name": "ТОВ \"ПОСТАЧАЛЬНИК\"",
    "vendor_edrpou": "12345678",
    "vendor_ipn": null,
    "vendor_address": "м. Київ, вул. Хрещатик, 1",
    "vendor_phone": "+380441234567",
    "tax_system": "Загальна система",
    "vendor_iban": "UA123456789012345678901234",
    "vendor_bank": "АТ \"ПРИВАТБАНК\"",
    "vendor_bank_city": "Київ",
    "vendor_mfo": "305299",
    "currency": "UAH",
    "amount_untaxed": 10000.00,
    "amount_tax": 2000.00,
    "amount_total": 12000.00,
    "due_date": "2024-01-20"
  },
  "lines": [
    {
      "line_number": 1,
      "name": "Товар № 1",
      "quantity": 10.000,
      "unit": "шт",
      "price_unit": 1000.00,
      "tax_percent": 20,
      "price_subtotal": 10000.00,
      "price_total": 12000.00,
      "article": "ART-001",
      "ukt_zed": "12345678",
      "barcodes": ["4820012345678"]
    }
  ],
  "metadata": {
    "source": "invoice_001.pdf",
    "origin_invoice": null
  }
}
```

---

**Приклад 2: Неформатований текст (колонки зміщені)**

**Вхід (OCR текст):**
```
Товари (роботи, послуги) Кількість 
1 Труба мідна 1/4" 0.71 Halcor (50м) Ціна без ПДВ Сума без ПДВ 
50,0000 м 57,500 2 875,00 
2 Гайка 1/4" 
50,0000 шт 16,670 833,50
Разом: 3 708,50
У т.ч. ПДВ: 741,70
Всього із ПДВ: 4 450,20
```

**Аналіз:**
- Рядок 1: Назва "Труба мідна 1/4" 0.71 Halcor (50м)" → quantity=50.0 м, price_unit=57.50, price_subtotal=2875.00
  - Перевірка: 50.0 × 57.50 = 2875.00 ✅
  - price_total = 2875.00 × 1.20 = 3450.00
  
- Рядок 2: Назва "Гайка 1/4"" → quantity=50.0 шт, price_unit=16.67, price_subtotal=833.50
  - Перевірка: 50.0 × 16.67 = 833.50 ✅
  - price_total = 833.50 × 1.20 = 1000.20

- Підсумок: amount_untaxed = 2875.00 + 833.50 = 3708.50 ✅
- ПДВ: amount_tax = 741.70 (з документа)
- Всього: amount_total = 4450.20 (з документа)

**Вихід (JSON):**
```json
{
  "header": {
    "doc_type": "Рахунок",
    "doc_number": "48",
    "doc_date": "2025-01-21",
    "currency": "UAH",
    "amount_untaxed": 3708.50,
    "amount_tax": 741.70,
    "amount_total": 4450.20
  },
  "lines": [
    {
      "line_number": 1,
      "name": "Труба мідна 1/4\" 0.71 Halcor (50м)",
      "quantity": 50.0,
      "unit": "м",
      "price_unit": 57.50,
      "tax_percent": 20,
      "price_subtotal": 2875.00,
      "price_total": 3450.00
    },
    {
      "line_number": 2,
      "name": "Гайка 1/4\"",
      "quantity": 50.0,
      "unit": "шт",
      "price_unit": 16.67,
      "tax_percent": 20,
      "price_subtotal": 833.50,
      "price_total": 1000.20
    }
  ]
}
```

**Ключові моменти:**
- 0.71 в назві "Труба мідна 1/4" 0.71" — це характеристика (товщина), НЕ quantity!
- Quantity береться з окремої колонки (50,0000 м)
- Математика перевірена: кожен price_subtotal = quantity × price_unit
- Підсумки збігаються з документом
```
