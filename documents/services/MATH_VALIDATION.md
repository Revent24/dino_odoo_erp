# –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è - –Ø–∫ —Ü–µ –ø—Ä–∞—Ü—é—î

## –ü—Ä–æ–±–ª–µ–º–∞

**–†–∞–Ω—ñ—à–µ:** AI –∞–≥–µ–Ω—Ç –º–∞–≤ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –≤—Å—é –º–∞—Ç–µ–º–∞—Ç–∏–∫—É (–º–Ω–æ–∂–µ–Ω–Ω—è, –¥–æ–¥–∞–≤–∞–Ω–Ω—è, –ü–î–í).
- ‚ùå –ú–æ–¥–µ–ª—å "–∑–∞–≤–∏—Å–∞–ª–∞" –Ω–∞–º–∞–≥–∞—é—á–∏—Å—å –≤—Å–µ –ø–æ—Ä–∞—Ö—É–≤–∞—Ç–∏
- ‚ùå –¢–∞–π–º–∞—É—Ç–∏ —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥–Ω—ñ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è
- ‚ùå –ü–æ–º–∏–ª–∫–∏ –≤ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∞—Ö

## –†—ñ—à–µ–Ω–Ω—è

**–¢–µ–ø–µ—Ä:** AI —Ç—ñ–ª—å–∫–∏ –≤–∏—Ç—è–≥—É—î –¥–∞–Ω—ñ ‚Üí Python –ø–µ—Ä–µ–≤—ñ—Ä—è—î –º–∞—Ç–µ–º–∞—Ç–∏–∫—É

---

## –í–∏–º–æ–≥–∏ –¥–æ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó

### 1. –°—Ç–∞–≤–∫–∞ –ü–î–í (tax_percent)

**–ü—Ä–∞–≤–∏–ª–æ:** –°—Ç–∞–≤–∫–∞ –ü–î–í –ó–ê–ì–ê–õ–¨–ù–ê –¥–ª—è –≤—Å—å–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –ù–ï –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —Ä—è–¥–∫–∞ –æ–∫—Ä–µ–º–æ.

**–Ø–∫ –≤–∏–∑–Ω–∞—á–∏—Ç–∏:**
```python
tax_percent = ((amount_total - amount_untaxed) / amount_untaxed) * 100
```

**–¢–∏–ø–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è:**
- `0%` - –±–µ–∑ –ü–î–í
- `20%` - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞ —Å—Ç–∞–≤–∫–∞ –≤ –£–∫—Ä–∞—ó–Ω—ñ
- `7%` - —Ä—ñ–¥–∫–æ (–∫–Ω–∏–≥–∏, –ª—ñ–∫–∏)

**–†—ñ—à–µ–Ω–Ω—è:**
- AI –ù–ï –≤–∏—Ç—è–≥—É—î `tax_percent` –∑ —Ä—è–¥–∫—ñ–≤
- Python —Ä–æ–∑—Ä–∞—Ö–æ–≤—É—î –û–î–ò–ù —Ä–∞–∑ –∑ –ø—ñ–¥—Å—É–º–∫—ñ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞
- –ó–∞—Å—Ç–æ—Å–æ–≤—É—î –¥–æ –≤—Å—ñ—Ö —Ä—è–¥–∫—ñ–≤

---

### 2. –û–¥–∏–Ω–∏—Ü—ñ –≤–∏–º—ñ—Ä—É (unit)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ë–∞–≥–∞—Ç–æ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ –Ω–∞–ø–∏—Å–∞–Ω–Ω—è: "—à—Ç", "—à—Ç.", "pc", "–ø–æ–≥.–º", "–º.–ø.", "–∫–≥", "–ª"

**–†—ñ—à–µ–Ω–Ω—è:**

**–í–∞—Ä—ñ–∞–Ω—Ç –ê:** –°–ø–∏—Å–æ–∫ –≤ –ø—Ä–æ–º–ø—Ç—ñ (—à–≤–∏–¥—à–µ, –±–µ–∑ –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ –ë–î)
```python
UNITS_LIST = ["—à—Ç", "—à—Ç.", "pc", "–æ–¥", "–æ–¥.", "–∫–≥", "–≥", "—Ç", "–ª", "–º–ª", 
              "–º", "—Å–º", "–º–º", "–º¬≤", "–º¬≥", "–º.–ø.", "–ø–æ–≥.–º", "–∫–æ–º–ø–ª", "—É–ø"]
```
‚Üí –î–æ–¥–∞—Ç–∏ –≤ —à–∞–±–ª–æ–Ω: "–ú–æ–∂–ª–∏–≤—ñ –æ–¥–∏–Ω–∏—Ü—ñ: —à—Ç, –∫–≥, –º, –ª, –∫–æ–º–ø–ª, ..."

**–í–∞—Ä—ñ–∞–Ω—Ç –ë:** –ó–∞–ø–∏—Ç –¥–æ –ë–î (—Ç–æ—á–Ω—ñ—à–µ, –∞–∫—Ç—É–∞–ª—å–Ω—ñ—à–µ)
```python
# –ü–µ—Ä–µ–¥ –≤–∏–∫–ª–∏–∫–æ–º AI
units_from_db = env['uom.uom'].search([]).mapped('name')
# –î–æ–¥–∞—Ç–∏ –≤ –ø—Ä–æ–º–ø—Ç: f"–û–¥–∏–Ω–∏—Ü—ñ: {', '.join(units_from_db)}"
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è:** –ü–æ—á–∞—Ç–∏ –∑ –≤–∞—Ä—ñ–∞–Ω—Ç–∞ –ê (—à–≤–∏–¥—à–µ), –ø–æ—Ç—ñ–º –¥–æ–¥–∞—Ç–∏ –ë —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ.

---

### 3. –ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó (name)

**–ü—Ä–∞–≤–∏–ª–æ:** –¢–µ–∫—Å—Ç –º—ñ–∂ –ø–æ—Ä—è–¥–∫–æ–≤–∏–º –Ω–æ–º–µ—Ä–æ–º —ñ –æ–¥–∏–Ω–∏—Ü—è–º–∏ –≤–∏–º—ñ—Ä—É

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä—è–¥–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞:**
```
‚Ññ | –ù–∞–π–º–µ–Ω—É–≤–∞–Ω–Ω—è                    | –ö—ñ–ª—å–∫—ñ—Å—Ç—å | –û–¥. | –¶—ñ–Ω–∞ | –°—É–º–∞
1 | –ê—Ä–∫—É—à –Ω–µ—Ä–∂–∞–≤—ñ–π–∫–∞ 201 0.8 (1.25–º)| 79.36     | –∫–≥  | 75.52| 5993.27
```

**–©–æ –≤–∏—Ç—è–≥—É–≤–∞—Ç–∏:**
- `name` = "–ê—Ä–∫—É—à –Ω–µ—Ä–∂–∞–≤—ñ–π–∫–∞ 201 0.8 (1.25–º)" (–ë–ï–ó –Ω–æ–º–µ—Ä–∞, –ë–ï–ó –æ–¥–∏–Ω–∏—Ü—ñ)
- –í–∫–ª—é—á–∞—î: –∫–∏—Ä–∏–ª–∏—Ü—é, –ª–∞—Ç–∏–Ω–∏—Ü—é, —Ü–∏—Ñ—Ä–∏, –¥—É–∂–∫–∏, —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∏

**–†—ñ—à–µ–Ω–Ω—è AI:**
- –®—É–∫–∞—Ç–∏ —Ç–µ–∫—Å—Ç –ü–Ü–°–õ–Ø –Ω–æ–º–µ—Ä–∞ —Ä—è–¥–∫–∞
- –ó–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è –ü–ï–†–ï–î –æ–¥–∏–Ω–∏—Ü–µ—é –≤–∏–º—ñ—Ä—É –∞–±–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—é

---

### 4. –¶—ñ–Ω–∏ —Ç–∞ —Å—É–º–∏ –ø–æ –ø–æ–∑–∏—Ü—ñ—è—Ö (–ù–ê–ô–í–ê–ñ–õ–ò–í–Ü–®–ï!)

**–©–æ AI –º–∞—î –≤–∏—Ç—è–≥—Ç–∏ –ó –ö–û–ñ–ù–û–ì–û –†–Ø–î–ö–ê:**

| –ü–æ–ª–µ | –û–ø–∏—Å | –û–±–æ–≤'—è–∑–∫–æ–≤–µ? |
|------|------|--------------|
| `quantity` | –ö—ñ–ª—å–∫—ñ—Å—Ç—å | ‚úÖ –¢–∞–∫ |
| `unit` | –û–¥–∏–Ω–∏—Ü—è –≤–∏–º—ñ—Ä—É | ‚úÖ –¢–∞–∫ |
| `price_unit` | –¶—ñ–Ω–∞ –ë–ï–ó –ü–î–í –∑–∞ –æ–¥–∏–Ω–∏—Ü—é | ‚ö†Ô∏è –Ø–∫—â–æ —î |
| `price_unit_with_tax` | –¶—ñ–Ω–∞ –ó –ü–î–í –∑–∞ –æ–¥–∏–Ω–∏—Ü—é | ‚ö†Ô∏è –Ø–∫—â–æ —î |
| `price_subtotal` | –°—É–º–∞ –ë–ï–ó –ü–î–í (qty √ó price) | ‚ö†Ô∏è –Ø–∫—â–æ —î |
| `price_total` | –°—É–º–∞ –ó –ü–î–í | ‚ö†Ô∏è –Ø–∫—â–æ —î |

**–í–∞–∂–ª–∏–≤–æ:** –ù–µ –≤—Å—ñ –ø–æ–ª—è –∑–∞–≤–∂–¥–∏ —î –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ñ!

**–ü—Ä–∏–∫–ª–∞–¥ 1:** –î–æ–∫—É–º–µ–Ω—Ç –ë–ï–ó –ü–î–í
```
–ö—ñ–ª—å–∫—ñ—Å—Ç—å: 10, –¶—ñ–Ω–∞: 100, –°—É–º–∞: 1000
‚Üí price_unit=100, price_subtotal=1000
‚Üí price_unit_with_tax=null, price_total=null (–Ω–µ–º–∞—î –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ñ)
```

**–ü—Ä–∏–∫–ª–∞–¥ 2:** –î–æ–∫—É–º–µ–Ω—Ç –ó –ü–î–í (–æ–∫—Ä–µ–º—ñ –∫–æ–ª–æ–Ω–∫–∏)
```
–ö—ñ–ª—å–∫: 10, –¶—ñ–Ω–∞: 100, –°—É–º–∞: 1000, –¶—ñ–Ω–∞ –∑ –ü–î–í: 120, –°—É–º–∞ –∑ –ü–î–í: 1200
‚Üí price_unit=100, price_subtotal=1000
‚Üí price_unit_with_tax=120, price_total=1200
```

**–ü—Ä–∏–∫–ª–∞–¥ 3:** –¢—ñ–ª—å–∫–∏ —Ü—ñ–Ω–∞ –ó –ü–î–í (—Ç—Ä–µ–±–∞ —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –ë–ï–ó)
```
–ö—ñ–ª—å–∫: 10, –¶—ñ–Ω–∞ –∑ –ü–î–í: 120, –°—É–º–∞ –∑ –ü–î–í: 1200
‚Üí price_unit_with_tax=120, price_total=1200
‚Üí price_unit=null, price_subtotal=null (Python –ø–æ—Ä–∞—Ö—É—î)
```

**–ó–∞–≤–¥–∞–Ω–Ω—è AI:** –í–∏—Ç—è–≥—Ç–∏ –í–°–Ü —á–∏—Å–ª–∞ —è–∫—ñ —î ‚Üí Python —Ä–æ–∑–±–µ—Ä–µ—Ç—å—Å—è —â–æ –∑ –Ω–∏–º–∏ —Ä–æ–±–∏—Ç–∏

**–ó–∞–≤–¥–∞–Ω–Ω—è Python:**
1. –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ –ø–æ–ª—è
2. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –º–∞—Ç–µ–º–∞—Ç–∏–∫—É
3. –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏ —Å—Ç–∞–≤–∫—É –ü–î–í –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞

---

### 5. –ü—ñ–¥—Å—É–º–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (header)

**–©–æ AI –º–∞—î –≤–∏—Ç—è–≥—Ç–∏:**
```json
{
  "amount_untaxed": 18500.50,  // –í—Å—å–æ–≥–æ –ë–ï–ó –ü–î–í
  "amount_tax": 3700.10,        // –ü–î–í
  "amount_total": 22200.60      // –í—Å—å–æ–≥–æ –ó –ü–î–í
}
```

**Python –ø–µ—Ä–µ–≤—ñ—Ä—è—î:**
```python
# 1. –°—Ç–∞–≤–∫–∞ –ü–î–í
calculated_tax_percent = (amount_tax / amount_untaxed) * 100

# 2. –°—É–º–∞ —Ä—è–¥–∫—ñ–≤
lines_subtotal = sum(line['price_subtotal'])
lines_total = sum(line['price_total'])

# 3. –ü–æ—Ä—ñ–≤–Ω—è—Ç–∏
if lines_subtotal != amount_untaxed:
    # –ü–†–û–ë–õ–ï–ú–ê –û–ö–†–£–ì–õ–ï–ù–ù–Ø!
```

---

### 6. –ü–†–û–ë–õ–ï–ú–ê –û–ö–†–£–ì–õ–ï–ù–ù–Ø (–Ω–∞–π–±–æ–ª—é—á—ñ—à–µ!)

**–°–∏—Ç—É–∞—Ü—ñ—è:**
```
–†—è–¥–æ–∫ 1: 79.36 √ó 75.52 = 5993.27
–†—è–¥–æ–∫ 2: 45.20 √ó 132.80 = 6002.56
–†—è–¥–æ–∫ 3: 120.00 √ó 55.00 = 6600.00
-------------------------------------------
–°–£–ú–ê —Ä—è–¥–∫—ñ–≤:              18595.83

–ê–ª–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ñ –ø—ñ–¥—Å—É–º–æ–∫:  18595.50  ‚Üê –†–Ü–ó–ù–ò–¶–Ø 0.33!
```

**–ß–æ–º—É —Ç–∞–∫?**
- –û–∫—Ä—É–≥–ª–µ–Ω–Ω—è –Ω–∞ –∫–æ–∂–Ω–æ–º—É —Ä—è–¥–∫—É –Ω–∞–∫–æ–ø–∏—á—É—î—Ç—å—Å—è
- –î–æ–∫—É–º–µ–Ω—Ç –º–æ–∂–µ –æ–∫—Ä—É–≥–ª—è—Ç–∏ —ñ–Ω–∞–∫—à–µ (banker's rounding, truncate)
- –ë—É—Ö–≥–∞–ª—Ç–µ—Ä—ñ—è –æ–∫—Ä—É–≥–ª—è—î –ø—ñ–¥—Å—É–º–æ–∫, –∞ –Ω–µ —Ä—è–¥–∫–∏

**–ü–†–ê–í–ò–õ–û:** –ü—ñ–¥—Å—É–º–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞ = —ñ—Å—Ç–∏–Ω–∞! (–ø—Ä–µ–¥–º–µ—Ç –æ–ø–ª–∞—Ç–∏)

**–†—ñ—à–µ–Ω–Ω—è - –†–æ–∑–ø–æ–¥—ñ–ª —Ä—ñ–∑–Ω–∏—Ü—ñ (Adjustment):**

```python
# –ö—Ä–æ–∫ 1: –ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏ —Ä—ñ–∑–Ω–∏—Ü—é
difference = document_total - sum_of_lines  # 18595.50 - 18595.83 = -0.33

# –ö—Ä–æ–∫ 2: –†–æ–∑–ø–æ–¥—ñ–ª–∏—Ç–∏ –ø—Ä–æ–ø–æ—Ä—Ü—ñ–π–Ω–æ –ø–æ —Ä—è–¥–∫–∞—Ö
for line in lines:
    weight = line['price_subtotal'] / sum_of_lines  # –ß–∞—Å—Ç–∫–∞ —Ä—è–¥–∫–∞
    adjustment = difference * weight  # –°–∫—ñ–ª—å–∫–∏ –¥–æ–¥–∞—Ç–∏/–≤—ñ–¥–Ω—è—Ç–∏
    line['price_subtotal'] += adjustment  # –ö–æ—Ä–∏–≥—É–≤–∞—Ç–∏
    
# –ö—Ä–æ–∫ 3: –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ price_total –∑ –Ω–æ–≤–∏–º–∏ subtotal
for line in lines:
    line['price_total'] = line['price_subtotal'] * (1 + tax_percent/100)

# –†–µ–∑—É–ª—å—Ç–∞—Ç: –°—É–º–∞ —Ä—è–¥–∫—ñ–≤ –¢–û–ß–ù–û = –ø—ñ–¥—Å—É–º–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞!
```

**–ê–ª–≥–æ—Ä–∏—Ç–º –¥–µ—Ç–∞–ª—å–Ω–æ:**

1. **–í–∏—Ç—è–≥—Ç–∏ –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞** (AI):
   - –ü—ñ–¥—Å—É–º–∫–∏: `amount_untaxed`, `amount_total`
   - –ü–æ —Ä—è–¥–∫–∞—Ö: –≤—Å—ñ –¥–æ—Å—Ç—É–ø–Ω—ñ —á–∏—Å–ª–∞

2. **–†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ –ø–æ–ª—è** (Python):
   - –Ø–∫—â–æ —î `price_unit` —ñ `quantity` ‚Üí `price_subtotal = qty √ó price`
   - –Ø–∫—â–æ —î —Ç—ñ–ª—å–∫–∏ `price_unit_with_tax` ‚Üí `price_unit = price_with_tax / (1 + tax%)`

3. **–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—É–º–∏ —Ä—è–¥–∫—ñ–≤**:
   ```python
   lines_sum = sum(line['price_subtotal'] for line in lines)
   difference = amount_untaxed - lines_sum
   ```

4. **–Ø–∫—â–æ —Ä—ñ–∑–Ω–∏—Ü—è > 0.01** (–±—ñ–ª—å—à–µ –∫–æ–ø—ñ–π–∫–∏) ‚Üí –†–æ–∑–ø–æ–¥—ñ–ª–∏—Ç–∏:
   ```python
   for line in lines:
       adjustment = difference * (line['price_subtotal'] / lines_sum)
       line['price_subtotal'] = round(line['price_subtotal'] + adjustment, 2)
   ```

5. **–û—Å—Ç–∞—Ç–æ—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞:**
   ```python
   assert sum(line['price_subtotal']) == amount_untaxed, "–°—É–º–∏ –Ω–µ —Å—Ö–æ–¥—è—Ç—å—Å—è!"
   ```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–∏—Ö (–æ–Ω–æ–≤–ª–µ–Ω–∞)

### Line (—Ä—è–¥–æ–∫ —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—ó):
```json
{
  "line_number": 1,
  "name": "–ê—Ä–∫—É—à –Ω–µ—Ä–∂–∞–≤—ñ–π–∫–∞ 201",
  "quantity": 79.36,
  "unit": "–∫–≥",
  
  "price_unit": 75.52,              // –¶—ñ–Ω–∞ –ë–ï–ó –ü–î–í (–º–æ–∂–µ –±—É—Ç–∏ null)
  "price_unit_with_tax": 90.62,     // –¶—ñ–Ω–∞ –ó –ü–î–í (–º–æ–∂–µ –±—É—Ç–∏ null)
  
  "price_subtotal": 5993.27,        // –°—É–º–∞ –ë–ï–ó –ü–î–í (–º–æ–∂–µ –±—É—Ç–∏ null ‚Üí —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏)
  "price_total": 7191.92,           // –°—É–º–∞ –ó –ü–î–í (–º–æ–∂–µ –±—É—Ç–∏ null ‚Üí —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏)
  
  "tax_percent": 20.0,              // ‚ùå –ù–ï –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —Ç—É—Ç! –ó–∞–≥–∞–ª—å–Ω–∞ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞
  
  "article": "201-08",              // –ê—Ä—Ç–∏–∫—É–ª (–æ–ø—Ü—ñ–π–Ω–æ)
  "ukt_zed": "72193100"             // –£–ö–¢ –ó–ï–î (–æ–ø—Ü—ñ–π–Ω–æ)
}
```

### Header (–ø—ñ–¥—Å—É–º–∫–∏):
```json
{
  "amount_untaxed": 18595.50,      // –Ü–°–¢–ò–ù–ê –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
  "amount_tax": 3719.10,           // –Ü–°–¢–ò–ù–ê –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞
  "amount_total": 22314.60,        // –Ü–°–¢–ò–ù–ê –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–ü–†–ï–î–ú–ï–¢ –û–ü–õ–ê–¢–ò!)
  
  "tax_percent": 20.0,             // –†–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ Python: (tax / untaxed) √ó 100
  
  "doc_type": "–†–∞—Ö—É–Ω–æ–∫",
  "doc_number": "123",
  "doc_date": "2026-01-09",
  // ... —ñ–Ω—à—ñ –ø–æ–ª—è
}
```

---

## –ü–æ—Ä—è–¥–æ–∫ –æ–±—Ä–æ–±–∫–∏ (Algorithm)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. AI –≤–∏—Ç—è–≥—É—î (RAW DATA)            ‚îÇ
‚îÇ    ‚Ä¢ Header: –ø—ñ–¥—Å—É–º–∫–∏ –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞   ‚îÇ
‚îÇ    ‚Ä¢ Lines: –í–°–Ü —á–∏—Å–ª–∞ —è–∫—ñ —î         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚¨áÔ∏è
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. Python: –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ —Å—Ç–∞–≤–∫—É –ü–î–í   ‚îÇ
‚îÇ    tax% = (tax / untaxed) √ó 100     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚¨áÔ∏è
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. Python: –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ –ø–æ–ª—è  ‚îÇ
‚îÇ    ‚Ä¢ price_unit ‚Üí price_subtotal    ‚îÇ
‚îÇ    ‚Ä¢ price_unit_with_tax ‚Üí price_unit‚îÇ
‚îÇ    ‚Ä¢ subtotal ‚Üí total (–∑ –ü–î–í)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚¨áÔ∏è
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 4. Python: –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å—É–º–∏          ‚îÇ
‚îÇ    sum(lines) =? amount_untaxed     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚¨áÔ∏è
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 5. Python: –†–æ–∑–ø–æ–¥—ñ–ª–∏—Ç–∏ —Ä—ñ–∑–Ω–∏—Ü—é      ‚îÇ
‚îÇ    (adjustment –ø–æ —Ä—è–¥–∫–∞—Ö)           ‚îÇ
‚îÇ    ‚Üí sum(lines) === amount_untaxed  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚¨áÔ∏è
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 6. –†–µ–∑—É–ª—å—Ç–∞—Ç: –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–æ —Ç–æ—á–Ω–∏–π!   ‚îÇ
‚îÇ    ‚úÖ –°—É–º–∞ —Ä—è–¥–∫—ñ–≤ = –ü—ñ–¥—Å—É–º–æ–∫        ‚îÇ
‚îÇ    ‚úÖ –í—Å—ñ –ø–æ–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω—ñ            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ü–æ–¥—ñ–ª –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–æ—Å—Ç—ñ:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  AI (Google Gemini / OpenRouter)        ‚îÇ
‚îÇ  ‚Ä¢ –†–æ–∑–ø—ñ–∑–Ω–∞—î —Ç–µ–∫—Å—Ç/–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è          ‚îÇ
‚îÇ  ‚Ä¢ –í–∏—Ç—è–≥—É—î –í–°–Ü –ß–ò–°–õ–ê –Ø–ö –Ñ              ‚îÇ
‚îÇ  ‚Ä¢ quantity, price_unit,                ‚îÇ
‚îÇ    price_unit_with_tax, price_subtotal, ‚îÇ
‚îÇ    price_total - –≤—Å–µ —â–æ —î –≤ –¥–æ–∫—É–º–µ–Ω—Ç—ñ   ‚îÇ
‚îÇ  ‚Ä¢ –ü—ñ–¥—Å—É–º–∫–∏ –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ü–°–¢–ò–ù–ê!)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚¨áÔ∏è  JSON –∑ –¥–∞–Ω–∏–º–∏
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Python (_validate_and_fix_math)        ‚îÇ
‚îÇ  ‚Ä¢ –†–æ–∑—Ä–∞—Ö–æ–≤—É—î —Å—Ç–∞–≤–∫—É –ü–î–í –∑ –ø—ñ–¥—Å—É–º–∫—ñ–≤    ‚îÇ
‚îÇ  ‚Ä¢ –ó–∞–ø–æ–≤–Ω—é—î –≤—ñ–¥—Å—É—Ç–Ω—ñ –ø–æ–ª—è              ‚îÇ
‚îÇ  ‚Ä¢ –ü–µ—Ä–µ–≤—ñ—Ä—è—î: sum(lines) = total?       ‚îÇ
‚îÇ  ‚Ä¢ –†–æ–∑–ø–æ–¥—ñ–ª—è—î —Ä—ñ–∑–Ω–∏—Ü—é –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è        ‚îÇ
‚îÇ  ‚Ä¢ –ì–∞—Ä–∞–Ω—Ç—É—î: —Å—É–º–∞ —Ä—è–¥–∫—ñ–≤ === –ø—ñ–¥—Å—É–º–æ–∫   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –©–æ —Ä–æ–±–∏—Ç—å `_validate_and_fix_math()` (–æ–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è)

### –ï—Ç–∞–ø 1: –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Å—Ç–∞–≤–∫–∏ –ü–î–í

```python
# –ó –ø—ñ–¥—Å—É–º–∫—ñ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–û–î–ò–ù —Ä–∞–∑ –¥–ª—è –≤—Å—å–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞)
if header.get('amount_untaxed') and header.get('amount_tax'):
    tax_percent = (header['amount_tax'] / header['amount_untaxed']) * 100
    header['tax_percent'] = round(tax_percent, 2)  # 0, 7, –∞–±–æ 20
else:
    # –Ø–∫—â–æ –ø—ñ–¥—Å—É–º–∫—ñ–≤ –Ω–µ–º–∞—î ‚Üí –∑ —Ä—ñ–∑–Ω–∏—Ü—ñ amount_total - amount_untaxed
    if header.get('amount_total') and header.get('amount_untaxed'):
        header['amount_tax'] = header['amount_total'] - header['amount_untaxed']
        header['tax_percent'] = (header['amount_tax'] / header['amount_untaxed']) * 100
```

### –ï—Ç–∞–ø 2: –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –≤—ñ–¥—Å—É—Ç–Ω—ñ—Ö –ø–æ–ª—ñ–≤ —É —Ä—è–¥–∫–∞—Ö

```python
for line in lines:
    qty = line.get('quantity', 0)
    price_unit = line.get('price_unit')
    price_unit_with_tax = line.get('price_unit_with_tax')
    price_subtotal = line.get('price_subtotal')
    price_total = line.get('price_total')
    
    # –°—Ü–µ–Ω–∞—Ä—ñ–π 1: –Ñ —Ü—ñ–Ω–∞ –ë–ï–ó –ü–î–í
    if price_unit and qty:
        if not price_subtotal:
            line['price_subtotal'] = round(qty * price_unit, 2)
        if not price_unit_with_tax:
            line['price_unit_with_tax'] = round(price_unit * (1 + tax_percent/100), 2)
        if not price_total:
            line['price_total'] = round(line['price_subtotal'] * (1 + tax_percent/100), 2)
    
    # –°—Ü–µ–Ω–∞—Ä—ñ–π 2: –Ñ —Ç—ñ–ª—å–∫–∏ —Ü—ñ–Ω–∞ –ó –ü–î–í
    elif price_unit_with_tax and qty:
        if not price_unit:
            line['price_unit'] = round(price_unit_with_tax / (1 + tax_percent/100), 2)
        if not price_total:
            line['price_total'] = round(qty * price_unit_with_tax, 2)
        if not price_subtotal:
            line['price_subtotal'] = round(line['price_total'] / (1 + tax_percent/100), 2)
    
    # –°—Ü–µ–Ω–∞—Ä—ñ–π 3: –Ñ —Ç—ñ–ª—å–∫–∏ —Å—É–º–∏
    elif price_subtotal and qty:
        if not price_unit:
            line['price_unit'] = round(price_subtotal / qty, 2)
        if not price_total:
            line['price_total'] = round(price_subtotal * (1 + tax_percent/100), 2)
```

### –ï—Ç–∞–ø 3: –†–æ–∑–ø–æ–¥—ñ–ª —Ä—ñ–∑–Ω–∏—Ü—ñ –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è

```python
# –ü–æ—Ä–∞—Ö—É–≤–∞—Ç–∏ —Å—É–º—É –≤—Å—ñ—Ö —Ä—è–¥–∫—ñ–≤
lines_subtotal = sum(line.get('price_subtotal', 0) for line in lines)
lines_total = sum(line.get('price_total', 0) for line in lines)

# –ü–æ—Ä—ñ–≤–Ω—è—Ç–∏ –∑ –ø—ñ–¥—Å—É–º–∫–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞
doc_untaxed = header.get('amount_untaxed', 0)
doc_total = header.get('amount_total', 0)

difference_untaxed = doc_untaxed - lines_subtotal
difference_total = doc_total - lines_total

# –Ø–∫—â–æ —Ä—ñ–∑–Ω–∏—Ü—è > 0.01 (–±—ñ–ª—å—à–µ 1 –∫–æ–ø—ñ–π–∫–∏) ‚Üí –†–û–ó–ü–û–î–Ü–õ–ò–¢–ò
if abs(difference_untaxed) > 0.01:
    _logger.warning(f"–†—ñ–∑–Ω–∏—Ü—è –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è: {difference_untaxed:.2f} –≥—Ä–Ω")
    
    # –†–æ–∑–ø–æ–¥—ñ–ª–∏—Ç–∏ –ø—Ä–æ–ø–æ—Ä—Ü—ñ–π–Ω–æ –ø–æ —Ä—è–¥–∫–∞—Ö
    for line in lines:
        weight = line['price_subtotal'] / lines_subtotal if lines_subtotal else 0
        adjustment = round(difference_untaxed * weight, 2)
        line['price_subtotal'] = round(line['price_subtotal'] + adjustment, 2)
        
        # –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ price_total
        line['price_total'] = round(line['price_subtotal'] * (1 + tax_percent/100), 2)
    
    # –û—Å—Ç–∞–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ (–º–æ–∂–µ –∑–∞–ª–∏—à–∏—Ç–∏—Å—å 0.01 —á–µ—Ä–µ–∑ –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è adjustment)
    final_diff = doc_untaxed - sum(line['price_subtotal'] for line in lines)
    if abs(final_diff) == 0.01:
        # –î–æ–¥–∞—Ç–∏/–≤—ñ–¥–Ω—è—Ç–∏ –æ—Å—Ç–∞–Ω–Ω—é –∫–æ–ø—ñ–π–∫—É –¥–æ –Ω–∞–π–±—ñ–ª—å—à–æ–≥–æ —Ä—è–¥–∫–∞
        max_line = max(lines, key=lambda l: l['price_subtotal'])
        max_line['price_subtotal'] = round(max_line['price_subtotal'] + final_diff, 2)
        max_line['price_total'] = round(max_line['price_subtotal'] * (1 + tax_percent/100), 2)
```

### –ï—Ç–∞–ø 4: –§—ñ–Ω–∞–ª—å–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è

```python
# –ì–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏ —â–æ —Å—É–º–∏ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å
assert sum(line['price_subtotal'] for line in lines) == doc_untaxed, \
    "–ö–†–ò–¢–ò–ß–ù–ê –ü–û–ú–ò–õ–ö–ê: –°—É–º–∞ —Ä—è–¥–∫—ñ–≤ –Ω–µ –¥–æ—Ä—ñ–≤–Ω—é—î –ø—ñ–¥—Å—É–º–∫—É!"

assert abs(sum(line['price_total'] for line in lines) - doc_total) < 0.02, \
    "–ü–û–ü–ï–†–ï–î–ñ–ï–ù–ù–Ø: –°—É–º–∞ –∑ –ü–î–í –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –±—ñ–ª—å—à–µ –Ω—ñ–∂ –Ω–∞ 2 –∫–æ–ø—ñ–π–∫–∏"

_logger.info("‚úÖ –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –ø—Ä–æ–π–¥–µ–Ω–∞ —É—Å–ø—ñ—à–Ω–æ")
```

---

## –ü–µ—Ä–µ–≤–∞–≥–∏ –Ω–æ–≤–æ–≥–æ –ø—ñ–¥—Ö–æ–¥—É

### ‚úÖ –®–≤–∏–¥–∫—ñ—Å—Ç—å
- AI –≤–∏—Ç—Ä–∞—á–∞—î 5-15 —Å–µ–∫—É–Ω–¥ (–±—É–ª–æ 30-60+)
- –ù–µ–º–∞—î –∑–∞–≤–∏—Å–∞–Ω—å —á–µ—Ä–µ–∑ —Å–∫–ª–∞–¥–Ω—ñ –æ–±—á–∏—Å–ª–µ–Ω–Ω—è
- –¢–∞–π–º–∞—É—Ç–∏ –∑–±—ñ–ª—å—à–µ–Ω—ñ, –∞–ª–µ –±—ñ–ª—å—à–µ –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ

### ‚úÖ –¢–æ—á–Ω—ñ—Å—Ç—å
- Python –∑–∞–≤–∂–¥–∏ —Ä–∞—Ö—É—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- AI –Ω–µ –º–æ–∂–µ –ø–æ–º–∏–ª–∏—Ç–∏—Å—è –≤ –º–∞—Ç–µ–º–∞—Ç–∏—Ü—ñ (–±–æ –Ω–µ —Ä–∞—Ö—É—î)
- –ü—ñ–¥—Å—É–º–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞ = –Ü–°–¢–ò–ù–ê (—Ä–æ–∑–ø–æ–¥—ñ–ª —Ä—ñ–∑–Ω–∏—Ü—ñ –ø–æ —Ä—è–¥–∫–∞—Ö)

### ‚úÖ –ü—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å
- –í—Å—ñ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –≤ –ª–æ–≥–∞—Ö
- –ó—Ä–æ–∑—É–º—ñ–ª–æ –¥–µ AI –ø–æ–º–∏–ª–∏–≤—Å—è  
- –õ–µ–≥–∫–æ –∑–Ω–∞–π—Ç–∏ —Ä–æ–∑–±—ñ–∂–Ω–æ—Å—Ç—ñ

### ‚úÖ –ì–Ω—É—á–∫—ñ—Å—Ç—å
- –ü—Ä–∞—Ü—é—î –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –ë–ï–ó –ü–î–í
- –ü—Ä–∞—Ü—é—î –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏ –ó –ü–î–í
- –ü—Ä–∞—Ü—é—î –∫–æ–ª–∏ —î —Ç—ñ–ª—å–∫–∏ —Ü—ñ–Ω–∞ –ë–ï–ó –∞–±–æ –ó –ü–î–í
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑–ø–æ–¥—ñ–ª—è—î –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è

---

## –ü—Ä–∏–∫–ª–∞–¥–∏ —Ä–æ–±–æ—Ç–∏

### –ü—Ä–∏–∫–ª–∞–¥ 1: –î–æ–∫—É–º–µ–Ω—Ç –ë–ï–ó –ü–î–í (—Ç—ñ–ª—å–∫–∏ price_unit)

**–í—Ö—ñ–¥ (AI –≤–∏—Ç—è–≥—É—î):**
```json
{
  "header": {
    "amount_untaxed": 18595.50,
    "amount_total": 18595.50,
    "amount_tax": 0
  },
  "lines": [
    {"quantity": 79.36, "price_unit": 75.52, "unit": "–∫–≥"},
    {"quantity": 45.20, "price_unit": 132.80, "unit": "—à—Ç"},
    {"quantity": 120.00, "price_unit": 55.00, "unit": "–º"}
  ]
}
```

**Python –æ–±—Ä–æ–±–ª—è—î:**
```python
# 1. –°—Ç–∞–≤–∫–∞ –ü–î–í
tax_percent = 0% (amount_tax = 0)

# 2. –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ –ø–æ–ª—è
line[0]: price_subtotal = 79.36 √ó 75.52 = 5993.27
line[1]: price_subtotal = 45.20 √ó 132.80 = 6002.56
line[2]: price_subtotal = 120.00 √ó 55.00 = 6600.00

# 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—É–º–∏
sum = 5993.27 + 6002.56 + 6600.00 = 18595.83
document = 18595.50
difference = -0.33 ‚Üê –û–ö–†–£–ì–õ–ï–ù–ù–Ø!

# 4. –†–æ–∑–ø–æ–¥—ñ–ª–∏—Ç–∏ —Ä—ñ–∑–Ω–∏—Ü—é
line[0]: adjustment = -0.33 √ó (5993.27/18595.83) = -0.11 ‚Üí 5993.16
line[1]: adjustment = -0.33 √ó (6002.56/18595.83) = -0.11 ‚Üí 6002.45  
line[2]: adjustment = -0.33 √ó (6600.00/18595.83) = -0.12 ‚Üí 6599.88
       (–æ—Å—Ç–∞–Ω–Ω—è –∫–æ–ø—ñ–π–∫–∞ –¥–æ –Ω–∞–π–±—ñ–ª—å—à–æ–≥–æ)

# 5. –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ 5993.16 + 6002.45 + 6599.89 = 18595.50 (–¢–û–ß–ù–û!)
```

---

### –ü—Ä–∏–∫–ª–∞–¥ 2: –î–æ–∫—É–º–µ–Ω—Ç –ó –ü–î–í (price_unit + price_unit_with_tax)

**–í—Ö—ñ–¥ (AI –≤–∏—Ç—è–≥—É—î):**
```json
{
  "header": {
    "amount_untaxed": 10000.00,
    "amount_tax": 2000.00,
    "amount_total": 12000.00
  },
  "lines": [
    {
      "quantity": 100,
      "price_unit": 50.00,        // –ë–ï–ó –ü–î–í
      "price_unit_with_tax": 60.00, // –ó –ü–î–í
      "unit": "—à—Ç"
    },
    {
      "quantity": 100,
      "price_unit": 50.00,
      "price_unit_with_tax": 60.00,
      "unit": "—à—Ç"
    }
  ]
}
```

**Python –æ–±—Ä–æ–±–ª—è—î:**
```python
# 1. –°—Ç–∞–≤–∫–∞ –ü–î–í
tax_percent = (2000 / 10000) √ó 100 = 20%

# 2. –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ –ø–æ–ª—è
line[0]: 
  price_subtotal = 100 √ó 50.00 = 5000.00
  price_total = 5000.00 √ó 1.20 = 6000.00
  
line[1]: —Ç–µ–∂ —Å–∞–º–µ ‚Üí 5000.00 / 6000.00

# 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
sum_untaxed = 5000 + 5000 = 10000.00 ‚úÖ
sum_total = 6000 + 6000 = 12000.00 ‚úÖ
difference = 0.00 ‚Üê –ù–µ–º–∞—î –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è!

# 4. –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ —Ç–æ—á–Ω–∞, –Ω—ñ—á–æ–≥–æ –∫–æ—Ä–∏–≥—É–≤–∞—Ç–∏ –Ω–µ —Ç—Ä–µ–±–∞
```

---

### –ü—Ä–∏–∫–ª–∞–¥ 3: –î–æ–∫—É–º–µ–Ω—Ç –ó –ü–î–í (—Ç—ñ–ª—å–∫–∏ price_unit_with_tax)

**–í—Ö—ñ–¥ (AI –≤–∏—Ç—è–≥—É—î):**
```json
{
  "header": {
    "amount_total": 12000.00,
    "amount_untaxed": null,  // ‚Üê –ù–µ–º–∞—î!
    "amount_tax": null
  },
  "lines": [
    {"quantity": 100, "price_unit_with_tax": 60.00, "unit": "—à—Ç"},
    {"quantity": 100, "price_unit_with_tax": 60.00, "unit": "—à—Ç"}
  ]
}
```

**Python –æ–±—Ä–æ–±–ª—è—î:**
```python
# 1. –°–ø–æ—á–∞—Ç–∫—É –ø–æ—Ä–∞—Ö—É–≤–∞—Ç–∏ price_total
line[0]: price_total = 100 √ó 60 = 6000.00
line[1]: price_total = 100 √ó 60 = 6000.00
sum_total = 12000.00 ‚úÖ

# 2. –Ø–∫—â–æ amount_untaxed –Ω–µ–º–∞—î, –∞–ª–µ —î amount_total
# –ü—Ä–∏–ø—É—Å—Ç–∏—Ç–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É —Å—Ç–∞–≤–∫—É 20%
assumed_tax_percent = 20%
header['amount_untaxed'] = 12000 / 1.20 = 10000.00
header['amount_tax'] = 12000 - 10000 = 2000.00

# 3. –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ price_unit –ë–ï–ó –ü–î–í
line[0]: 
  price_unit = 60 / 1.20 = 50.00
  price_subtotal = 100 √ó 50 = 5000.00
  
line[1]: —Ç–µ–∂ —Å–∞–º–µ

# 4. –†–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ amount_untaxed = 10000.00 (—Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ)
‚úÖ amount_tax = 2000.00 (—Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ)
```

---

### –ü—Ä–∏–∫–ª–∞–¥ 4: –°–ö–õ–ê–î–ù–ò–ô - –†—ñ–∑–Ω—ñ —Ü—ñ–Ω–∏, –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è, –Ω–µ–ø–æ–≤–Ω—ñ –¥–∞–Ω—ñ

**–í—Ö—ñ–¥ (—Ä–µ–∞–ª—å–Ω–∏–π –¥–æ–∫—É–º–µ–Ω—Ç):**
```json
{
  "header": {
    "amount_untaxed": 18595.50,  // ‚Üê –Ü–°–¢–ò–ù–ê!
    "amount_total": 22314.60
  },
  "lines": [
    {"quantity": 79.36, "price_unit": 75.52, "unit": "–∫–≥"},
    {"quantity": 45.20, "price_subtotal": 6002.00, "unit": "—à—Ç"},  // —Ç—ñ–ª—å–∫–∏ —Å—É–º–∞
    {"quantity": 120.00, "price_unit_with_tax": 66.00, "unit": "–º"} // —Ç—ñ–ª—å–∫–∏ —Ü—ñ–Ω–∞ –∑ –ü–î–í
  ]
}
```

**Python –æ–±—Ä–æ–±–ª—è—î:**
```python
# 1. –°—Ç–∞–≤–∫–∞ –ü–î–í
tax_percent = (22314.60 - 18595.50) / 18595.50 √ó 100 = 20%

# 2. –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ –ø–æ–ª—è
line[0]: 
  price_subtotal = 79.36 √ó 75.52 = 5993.27
  price_total = 5993.27 √ó 1.20 = 7191.92

line[1]:
  price_unit = 6002.00 / 45.20 = 132.79 (–∑–≤–æ—Ä–æ—Ç–Ω–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫)
  price_total = 6002.00 √ó 1.20 = 7202.40

line[2]:
  price_unit = 66.00 / 1.20 = 55.00
  price_subtotal = 120 √ó 55 = 6600.00
  price_total = 66.00 √ó 120 = 7920.00

# 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—É–º–∏
sum_untaxed = 5993.27 + 6002.00 + 6600.00 = 18595.27
document = 18595.50
difference = +0.23 ‚Üê –û–ö–†–£–ì–õ–ï–ù–ù–Ø!

# 4. –†–æ–∑–ø–æ–¥—ñ–ª–∏—Ç–∏ +0.23
line[0]: +0.07 ‚Üí 5993.34
line[1]: +0.07 ‚Üí 6002.07
line[2]: +0.09 ‚Üí 6600.09

# 5. –ü–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏ price_total
line[0]: 5993.34 √ó 1.20 = 7192.01
line[1]: 6002.07 √ó 1.20 = 7202.48
line[2]: 6600.09 √ó 1.20 = 7920.11

# 6. –§—ñ–Ω–∞–ª—å–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
‚úÖ 5993.34 + 6002.07 + 6600.09 = 18595.50 (–¢–û–ß–ù–û!)
‚úÖ 7192.01 + 7202.48 + 7920.11 = 22314.60 (–¢–û–ß–ù–û!)
```

---

## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

### –ü–æ—Ö–∏–±–∫–∞ –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è:
```python
# –í –∫–æ–¥—ñ: diff > 0.02 ‚Üí –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è
# –ú–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏ –Ω–∞ 0.05 –¥–ª—è –±—ñ–ª—å—à–æ—ó —Ç–æ–ª–µ—Ä–∞–Ω—Ç–Ω–æ—Å—Ç—ñ
```

### –õ–æ–≥–∏:
```python
_logger.info("üìä Math validation: 3 adjustments")
_logger.debug("  –†—è–¥–æ–∫ 1: –†–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ price_total = 7191.92")
_logger.debug("  Header: –†–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ amount_untaxed = 18500.50")
```

### –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è:
```python
result['metadata']['math_warnings'] = [
    "–†—è–¥–æ–∫ 1: –†–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ price_subtotal = 5993.27",
    "‚ö†Ô∏è –†—è–¥–æ–∫ 2: –ú–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞! ...",
    "Header: –†–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ amount_total = 22200.60"
]
```

## –©–æ –¥–∞–ª—ñ?

–¢–µ–ø–µ—Ä AI –∞–≥–µ–Ω—Ç–∏:
- ‚úÖ –®–≤–∏–¥–∫–æ —Ä–æ–∑–ø—ñ–∑–Ω–∞—é—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∏ (5-15 —Å–µ–∫)
- ‚úÖ –ù–µ –∑–∞–≤–∏—Å–∞—é—Ç—å –Ω–∞ –º–∞—Ç–µ–º–∞—Ç–∏—Ü—ñ
- ‚úÖ –ü–æ–≤–µ—Ä—Ç–∞—é—Ç—å —Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ (Python –ø–µ—Ä–µ–≤—ñ—Ä—è—î)
- ‚úÖ –î–∞—é—Ç—å –∑—Ä–æ–∑—É–º—ñ–ª—ñ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è —è–∫—â–æ —â–æ—Å—å –Ω–µ —Ç–∞–∫

**–ü—Ä–æ—Ç–µ—Å—Ç—É–π—Ç–µ –Ω–∞ –≤–∞—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö!** üöÄ
