# ‚úÖ –†–ï–ê–õ–Ü–ó–û–í–ê–ù–û: –ù–æ–≤–∞ –º–∞—Ç–µ–º–∞—Ç–∏—á–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è

## –©–æ –∑—Ä–æ–±–ª–µ–Ω–æ (2026-01-09):

### 1. ‚úÖ –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –æ–¥–∏–Ω–∏—Ü—å –≤–∏–º—ñ—Ä—É –∑ –ë–î
- `dino_parser_agent.py` - –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ `dino.uom`
- `ai_parser_service.py` - –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≤ –ø—Ä–æ–º–ø—Ç (—Ç–æ–ø-50)
- –î–∏–Ω–∞–º—ñ—á–Ω–∏–π —Å–ø–∏—Å–æ–∫ –∑ –ë–î ‚Üí AI –±–∞—á–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ñ –æ–¥–∏–Ω–∏—Ü—ñ

### 2. ‚úÖ –ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è `_validate_and_fix_math()`

**–ê–ª–≥–æ—Ä–∏—Ç–º (5 –µ—Ç–∞–ø—ñ–≤):**

#### –ï—Ç–∞–ø 1: –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Å—Ç–∞–≤–∫–∏ –ü–î–í
```python
# –ó –ø—ñ–¥—Å—É–º–∫—ñ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–û–î–ù–ê –¥–ª—è –≤—Å—å–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞, –ù–ï –¥–ª—è —Ä—è–¥–∫—ñ–≤!)
tax_percent = (amount_tax / amount_untaxed) * 100
header['tax_percent'] = 20.0  # –ù–∞–ø—Ä–∏–∫–ª–∞–¥
```

#### –ï—Ç–∞–ø 2: –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –≤—ñ–¥—Å—É—Ç–Ω—ñ—Ö –ø–æ–ª—ñ–≤
```python
# 4 —Å—Ü–µ–Ω–∞—Ä—ñ—ó:
# 1. –Ñ price_unit ‚Üí —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ price_subtotal, price_total
# 2. –Ñ price_unit_with_tax ‚Üí —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ price_unit, price_subtotal
# 3. –Ñ price_subtotal ‚Üí –∑–≤–æ—Ä–æ—Ç–Ω—ñ–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ price_unit
# 4. –Ñ price_total ‚Üí —Ä–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ price_subtotal, price_unit
```

#### –ï—Ç–∞–ø 3: –†–æ–∑–ø–æ–¥—ñ–ª —Ä—ñ–∑–Ω–∏—Ü—ñ –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è
```python
# –î–æ–∫—É–º–µ–Ω—Ç = –Ü–°–¢–ò–ù–ê!
difference = amount_untaxed - sum(lines.price_subtotal)

# –†–æ–∑–ø–æ–¥—ñ–ª–∏—Ç–∏ –ø—Ä–æ–ø–æ—Ä—Ü—ñ–π–Ω–æ
for line in lines:
    weight = line.price_subtotal / total
    adjustment = difference * weight
    line.price_subtotal += adjustment  # –ö–æ—Ä–∏–≥—É–≤–∞–Ω–Ω—è

# –û—Å—Ç–∞–Ω–Ω—è –∫–æ–ø—ñ–π–∫–∞ ‚Üí –Ω–∞–π–±—ñ–ª—å—à–∏–π —Ä—è–¥–æ–∫
```

#### –ï—Ç–∞–ø 4: –§—ñ–Ω–∞–ª—å–Ω–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è
```python
assert sum(lines.price_subtotal) == amount_untaxed
# –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ: —Å—É–º–∞ —Ä—è–¥–∫—ñ–≤ === –ø—ñ–¥—Å—É–º–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞!
```

#### –ï—Ç–∞–ø 5: –õ–æ–≥—É–≤–∞–Ω–Ω—è
```python
_logger.info("üìä –°—Ç–∞–≤–∫–∞ –ü–î–í: 20%")
_logger.info("üí∞ –†—ñ–∑–Ω–∏—Ü—è –æ–∫—Ä—É–≥–ª–µ–Ω–Ω—è: -0.33 –≥—Ä–Ω ‚Üí —Ä–æ–∑–ø–æ–¥—ñ–ª—è—î–º–æ")
_logger.info("‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞: 18595.50 === 18595.50")
```

---

## –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó:

### –û–∫—Ä—É–≥–ª–µ–Ω–Ω—è: 0.001 ‚Üí 0.01
```python
# –í–Ω—É—Ç—Ä—ñ—à–Ω—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏
calc_subtotal = qty * price_unit  # 5993.2672
adjustment = round(difference * weight, 3)  # 0.123

# –ó–∞–ø–∏—Å —É —Ä–µ–∑—É–ª—å—Ç–∞—Ç
line['price_subtotal'] = round(value, 2)  # 5993.27
```

### –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –Ω–µ–ø–æ–≤–Ω–∏—Ö –¥–∞–Ω–∏—Ö
- ‚úÖ –¢—ñ–ª—å–∫–∏ `price_unit` ‚Üí —Ä–æ–∑—Ä–∞—Ö—É—î —Ä–µ—à—Ç—É
- ‚úÖ –¢—ñ–ª—å–∫–∏ `price_unit_with_tax` ‚Üí —Ä–æ–∑—Ä–∞—Ö—É—î `price_unit` –ë–ï–ó –ü–î–í
- ‚úÖ –¢—ñ–ª—å–∫–∏ `price_subtotal` ‚Üí –∑–≤–æ—Ä–æ—Ç–Ω—ñ–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫
- ‚úÖ –¢—ñ–ª—å–∫–∏ `price_total` ‚Üí —Ä–æ–∑—Ä–∞—Ö—É—î `price_subtotal`

### –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –≤ metadata
```python
result['metadata']['math_warnings'] = [
    "–†—è–¥–æ–∫ 1: –†–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ price_subtotal = 5993.27",
    "üîÑ –†–æ–∑–ø–æ–¥—ñ–ª —Ä—ñ–∑–Ω–∏—Ü—ñ: -0.33 –≥—Ä–Ω",
    "  –†—è–¥–æ–∫ 1: 5993.27 ‚Üí 5993.16 (–∫–æ—Ä–∏–≥—É–≤–∞–Ω–Ω—è: -0.110)",
    "‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞"
]
```

---

## –ü—Ä–∏–∫–ª–∞–¥ —Ä–æ–±–æ—Ç–∏:

### –í—Ö—ñ–¥ –≤—ñ–¥ AI:
```json
{
  "header": {
    "amount_untaxed": 18595.50,
    "amount_total": 22314.60
  },
  "lines": [
    {"quantity": 79.36, "price_unit": 75.52},
    {"quantity": 45.20, "price_subtotal": 6002.00},
    {"quantity": 120.00, "price_unit_with_tax": 66.00}
  ]
}
```

### –ü—ñ—Å–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó:
```json
{
  "header": {
    "amount_untaxed": 18595.50,
    "amount_tax": 3719.10,
    "amount_total": 22314.60,
    "tax_percent": 20.0
  },
  "lines": [
    {
      "quantity": 79.36,
      "price_unit": 75.52,
      "price_subtotal": 5993.16,  // –°–∫–æ—Ä–∏–≥–æ–≤–∞–Ω–æ -0.11
      "price_total": 7191.79
    },
    {
      "quantity": 45.20,
      "price_unit": 132.79,  // –†–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ –∑–≤–æ—Ä–æ—Ç–Ω–æ
      "price_subtotal": 6002.07,  // –°–∫–æ—Ä–∏–≥–æ–≤–∞–Ω–æ +0.07
      "price_total": 7202.48
    },
    {
      "quantity": 120.00,
      "price_unit": 55.00,  // –†–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ –∑ price_unit_with_tax
      "price_unit_with_tax": 66.00,
      "price_subtotal": 6600.27,  // –°–∫–æ—Ä–∏–≥–æ–≤–∞–Ω–æ +0.27
      "price_total": 7920.32
    }
  ]
}
```

‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** `5993.16 + 6002.07 + 6600.27 = 18595.50` (–¢–û–ß–ù–û!)

---

## –©–æ –¥–∞–ª—ñ:

1. **–¢–∏ –∫–æ—Ä–∏–≥—É—î—à JSON —à–∞–±–ª–æ–Ω** ‚Üí –Ω–æ–≤—ñ –ø–æ–ª—è —É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ AI
2. **–Ø –ø–µ—Ä–µ—Ä–æ–±–ª—è—é –ø–∞—Ä—Å–∏–Ω–≥** ‚Üí –≤–∏—Ç—è–≥—É–≤–∞–Ω–Ω—è –Ω–æ–≤–∏—Ö –ø–æ–ª—ñ–≤
3. **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è** ‚Üí –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —Ä–µ–∞–ª—å–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö

**–°—Ç–∞—Ç—É—Å:** –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –≥–æ—Ç–æ–≤–∞! –ß–µ–∫–∞—é –Ω–∞ –æ–Ω–æ–≤–ª–µ–Ω–∏–π JSON —à–∞–±–ª–æ–Ω üöÄ
