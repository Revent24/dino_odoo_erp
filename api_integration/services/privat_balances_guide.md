# PrivatBank API - Тестирование импорта балансов

## Обзор функционала

Модуль позволяет импортировать балансы и обороты по счетам из API ПриватБанка.

### Что импортируется:

- **Название счета** (nameACC)
- **Номер счета / IBAN** (acc/iban)
- **Валюта** (currency)
- **Входящий остаток** (balanceIn) - на начало дня
- **Исходящий остаток** (balanceOut) - на конец дня
- **Оборот по дебету** (turnoverDebt) - сумма списаний
- **Оборот по кредиту** (turnoverCred) - сумма зачислений
- **Дата остатков** (dpd) - дата последнего движения
- **External ID** (acc) - внутренний ID счета в системе банка

## API Endpoint ПриватБанка

**URL:** `https://acp.privatbank.ua/api/statements/balance`

**Метод:** GET

**Обязательные заголовки:**
- `User-Agent`: DinoERP Integration
- `token`: API ключ (токен)
- `Content-Type`: application/json;charset=cp1251

**Необязательные заголовки:**
- `id`: Client ID (для группы предприятий)

**Параметры запроса:**
- `startDate`: Дата начала в формате DD-MM-YYYY (обязательный)
- `endDate`: Дата окончания в формате DD-MM-YYYY (необязательный)
- `acc`: Номер счета (необязательный, если не указан - по всем счетам)
- `followId`: ID следующей пачки для пагинации
- `limit`: Количество записей в пачке (макс. 500, рекомендуется 100)

## Настройка в Odoo

### 1. Создание банка

Перейдите в **Finance → Configuration → Banks** и создайте/найдите банк ПриватБанк:

- **MFO**: 305299
- **Название**: АТ КБ "ПРИВАТБАНК"
- **ЕДРПОУ**: 14360570

### 2. Создание API Endpoint

Перейдите в **API Integration → API Endpoints** и создайте новый эндпоинт:

**Основная информация:**
- **Name**: Privat Balances Import
- **Operation Type**: Импорт балансов счетов ПриватБанк
- **Bank**: АТ КБ "ПРИВАТБАНК" (MFO: 305299)

**Аутентификация:**
- **Token**: ваш API токен из настроек ПриватБанка
- **Client Id**: (необязательно) ID клиента для группы предприятий

**История:**
- **Start Date**: дата, с которой начинать загрузку истории

**Cron Settings** (необязательно):
- Настройте по необходимости для автоматического обновления

### 3. Получение API токена

1. Войдите в систему АЦП ПриватБанка: https://acp.privatbank.ua/
2. Перейдите в **Налаштування → API**
3. Скопируйте токен

## Ручной запуск импорта

### Через интерфейс Odoo

1. Откройте эндпоинт
2. Нажмите кнопку **Activate** (если эндпоинт неактивен)
3. Эндпоинт выполнит импорт

### Через скрипт

```bash
cd /path/to/dino_erp
python3 scripts/test_privat_balances.py --endpoint-id 1
```

С указанием даты:
```bash
python3 scripts/test_privat_balances.py --endpoint-id 1 --date 02-01-2026
```

## Результат импорта

После успешного импорта:

1. В базе данных создаются/обновляются записи **Bank Accounts**
2. Для каждого счета сохраняются:
   - Остатки (начальный и конечный)
   - Обороты (дебет и кредит)
   - Дата актуальности
   - Время последнего импорта

3. Просмотр счетов: **Finance → Bank Accounts**

## Просмотр результатов

### Список счетов

В списке отображаются:
- Название счета
- Номер счета (IBAN)
- Банк
- Валюта
- Дата остатков
- Начальный остаток
- Оборот по кредиту
- Оборот по дебету
- Конечный остаток
- Время последнего импорта

### Форма счета

Открыв счет, вы увидите:
- **Account Information:**
  - Название
  - IBAN
  - Банк
  - Валюта
  - External ID (внутренний ID банка)
  - Тип счета

- **Balance Information:**
  - Дата остатков
  - Начальный остаток
  - Оборот по кредиту
  - Оборот по дебету
  - Конечный остаток
  - Время последнего импорта

## Фильтры и группировка

В поиске доступны фильтры:
- **Active** - только активные счета
- **Archived** - только архивные счета
- **All** - все счета

Группировка:
- По банку
- По валюте
- По дате остатков

## Логика работы (Upsert)

При импорте счетов:

1. **Поиск существующего счета** по IBAN и банку
2. Если счет найден - **обновление** всех полей
3. Если счет не найден - **создание** нового
4. Счета без IBAN/номера **пропускаются**
5. Счета с неизвестной валютой **пропускаются**

## Обработка ошибок

### Ошибки API:
- **401 Unauthorized** - неверный токен
- **403 Forbidden** - нет доступа к данным
- **500 Server Error** - проблемы на стороне банка

### Валидация данных:
- Отсутствует токен → ошибка "Not specified API token"
- Отсутствует банк → ошибка "Bank not specified"
- Неверный формат даты → используется сегодняшняя дата

## Проверка статуса API

Перед импортом можно проверить статус API:

```python
from api_integration.services.privat_client import PrivatClient

client = PrivatClient(api_key='your_token')
is_ok = client.check_api_status()
# True если phase=WRK и work_balance=N
```

## Примеры ответов API

### Успешный ответ:

```json
{
  "status": "SUCCESS",
  "type": "balances",
  "exist_next_page": false,
  "balances": [
    {
      "acc": "26184050001514",
      "iban": "UA943052990000026100050001037",
      "currency": "UAH",
      "balanceIn": "1000.00",
      "balanceOut": "1500.00",
      "turnoverDebt": "200.00",
      "turnoverCred": "700.00",
      "dpd": "02.01.2026 18:30:00",
      "nameACC": "ТОВ КОМПАНІЯ",
      "state": "l"
    }
  ]
}
```

### Ответ с ошибкой:

```json
{
  "status": "ERROR",
  "message": "Invalid token"
}
```

## Кодировка

ПриватБанк использует кодировку **CP1251** (Windows-1251). Клиент автоматически обрабатывает декодирование.

## Лимиты и рекомендации

- **Пагинация**: Если счетов больше 100, используется автоматическая пагинация
- **Задержка между запросами**: 0.3 секунды (настраивается)
- **Timeout**: 30 секунд (настраивается)
- **Retry**: 3 попытки при ошибках 500/502/503/504

## Связанные файлы

- **Модель**: `api_integration/models/dino_api_endpoint.py`
- **Клиент API**: `api_integration/services/privat_client.py`
- **Сервис импорта**: `api_integration/services/privat_service.py`
- **Handler**: `api_integration/services/handlers.py`
- **Модель счетов**: `finance/models/dino_bank_account.py`
- **Представления**: `finance/views/dino_bank_acc_views.xml`
- **Тестовый скрипт**: `scripts/test_privat_balances.py`
- **Документация API**: `api_integration/services/privat_api.md`
