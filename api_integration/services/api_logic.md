
# ТЗ: Логика работы и настройки API интеграции (Odoo)

## 1. Принцип работы

Вся логика реализуется в рамках модели управления подключениями: `api_integration\models\dino_api_endpoint.py`.

Модель является "центром управления", где для каждой интеграции указывается:

* **Наименование:** Краткое название (например, "ПриватБанк: Выписка").
* **Обработчик (Handler):** Выбор Python-метода, реализующего специфику конкретного API.
* **Параметры подключения:** Client ID, Token (динамическое отображение в зависимости от хендлера).
* **Настройки Cron:** Индивидуальное расписание для каждого эндпоинта.

## 2. Перечень выполняемых процедур (Handlers)

- Импорт курсов НБУ (в таблицу `dino.currency.rate` и `res.currency.rate`, без параметров подключения)
- Импорт Курсов Приват банка (в таблицу `dino.currency.rate` и `res.currency.rate`)
- Импорт Курсов Mono банка (в таблицу `dino.currency.rate`)
- Импорт счетов Приват банка (с остатками и оборотами на декущую дату)
- Импорт счетов Mono банка (заглушка на перспективу)
- Импорт балансов по счетам Приват банка (за период)
- Импорт балансов по счетам Mono банка (за период, заглушка на перспективу)
- Импорт транзакций по счетам Приват банка (за период)
- Импорт транзакций по счетам Mono банка (за период, заглушка на перспективу)
- Обновление справочника контрагентов

    Уточнения: 
    - связь с банком не нужна, так как данные подключения указаны в настройках эндпоинта.

## 3. Настройка планировщика (Cron Settings)

Метод Cron является универсальной оберткой, которая имитирует нажатие кнопки **"Execute"** и логирует результат.

### Base Recurrence

* **Приоритет:** Integer (0 — высший).
* **Интервал:** Integer (например, 15).
* **Периодичность:** Selection (Minutes, Hours, Days, Weeks, Months).
* **Часовой пояс:** Selection (из `res.tz`, по умолчанию — TZ текущего пользователя).
* **Время старта:** * Для *Minutes/Hours* — это разрешенный интервал запуска (например, с 09:00 до 18:00).Для *Days/Weeks/Months* — время старта (например, запуск ровно в 09:00).
* **Время окончания:** * Для *Minutes/Hours* — время окончания разрешенного интервала (например, до 18:00).Для *Days/Weeks/Months* — не используется (скрывается).


### Advanced Filters

* **Кол-во повторов:** Integer (-1 — бесконечно).
* **Дни недели:** набор Boolean (Пн-Вс). Работает для всех типов периодичности.
* **День месяца:** Integer (1-31). Используется при периодичности "Months".
* **Последний день месяца:** Boolean. Используется при периодичности "Months". Если активен — игнорирует "День месяца" и всегда запускает в последний день.
* **Дата и время следующего запуска (Nextcall):** * Вычисляется автоматически в UTC.
* При расчете учитывается TZ, рабочее окно и фильтры дней. Если вычисленное время выпадает за рамки окна или в выходной, `nextcall` переносится на ближайшее разрешенное время (например, на утро понедельника).



## 4. Логирование (API Logs)

Модель: `api_integration\models\dino_api_log.py`. Каждое выполнение (Manual или Cron) создает запись:

* **Дата/время запуска** и **Длительность выполнения**.
* **Тип запуска:** Selection ('Manual', 'Cron').
* **Статус:** Selection ('Success', 'Error').
* **Детали:** Text/JSON (тело запроса/ответа, причина ошибки).
* **Результат:** Информационное сообщение (например, "Импортировано 15 записей").

## 5. UI реализация
* Переключатель активации эндпоинта неактивен для новыйых записей.
* При активации эндпоинта отображается кнопка **"Test Connection"** и деактивируются все поля подключения (редактировать можно только неактивный эндпоинт).
* Изменения в полях подключения либо сохраняются автоматически, либо при активации переключателя.
* Форма эндпоинта содержит вкладки: **"Connection Settings"** (динамические поля), **"Cron Settings"** и **"Execution Logs"** (история запусков).
* Кнопка **"Execute"** для мгновенного запуска (скрыта, когда эндпоинт неактивен).
* Поля конфиденциальных данных (Token/Secret) скрыты атрибутом `password="1"`.

## 6. Добавление новых конрагентов
    - при импорте транзакций из банков (модель dino.bank.transaction), если в данных транзакции встречается новый контрагент, которого нет в справочнике контрагентов (проверка по ОКПО в модели `dino.partners`), он автоматически создается. 

    Информация для создания контрагента берется из данных транзакции (название, ИНН, ОКПО, адрес, номер счета, банк контагента, город банка котрагента).

    После этого контрагент связывается с транзакцией.

    Вся остальная информация о контрагенте заполняется при выполнении процедуры *Обновление справочника контрагентов* 
    