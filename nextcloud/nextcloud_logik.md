# Логика работы раздела Nextcloud v4.0 для приложения Odoo

**Суть и принципы новой логики:**
В новой версии логики Nextcloud v4.0 Odoo становится мастер-копией структуры папок и файлов, а Nextcloud используется как "пассивное" хранилище данных. Все изменения в структуре и содержимом инициируются из Odoo, что позволяет централизовать управление и минимизировать риски рассинхронизации. Основные принципы включают:

1. **Централизация управления:** Odoo отвечает за создание, переименование, перемещение и удаление папок и файлов.
2. **Синхронизация:** Nextcloud синхронизируется с Odoo через API, используя системные идентификаторы (ID) и пути.
3. **Ограничение прав:** Пользователи могут только просматривать структуру, загружать и скачивать файлы, но не могут изменять структуру папок.
4. **Обработка ошибок:** Система автоматически обрабатывает случаи, когда объекты удаляются или перемещаются вручную в Nextcloud, чтобы избежать ошибок и рассинхронизации.

**Основной принцип:**
Odoo выступает в роли администратора и менеджера структуры папок в корневой директории Nextcloud. Пользователи имеют возможность управлять только своими файлами, без возможности изменять структуру папок.

---

## I. Подключение к Nextcloud

Параметры подключения указываются в записи модели `nextcloud.client`:

1. **Основные параметры:**
   - `url`: URL сервера Nextcloud (поле `Base URL`).
   - `username`: Имя пользователя.
   - `password`: Пароль пользователя.
   - `root_folder_id`: Уникальный системный ID корневой папки 
   - `root_folder_path`: Текущий путь к корневой папке

2. **Логика работы:**
   - **Первичный запуск:** Если `root_folder_id` пуст, или по указаному `root_folder_id` не удается найти папку, создается корневая папка `Odoo Docs`, извлекается её системный `file-id` и записывается в поле `root_folder_id`и актуальный путь в `root_folder_path`. 

   - **Повторное подключение:** Проверяем наличие папки по `root_folder_id` в корне облака. Если папка найдена, обновляем `root_folder_path`, если нет — создаем новую корневую папку `Odoo Docs`, регистрируем новый ID и путь. 
   
---

## II. Список файлов и папок (Проводник)

1. **Отображение содержимого:**
   - Структура папок в корневой папке `Odoo Docs` полностью управляется из Odoo, где она реализована в модели `nextcloud.file`.
   - После успешного подключения выполняется рекурсивная синхонизация структуры папок и файлов корневой папки `Odoo Docs`с моделью `nextcloud.file`. Потом все управление структурой папок происходит только из Odoo.
   - Модель `nextcloud.file` содержит поле `parent_file_id` для построения дерева папок внутри Odoo без запросов к API Nextcloud.
   - В Проводнике можно создавать, переименовывать, перемещать и удалять папки и файлы, и все эти действия синхронизируются с Nextcloud.

   - При клике на меню `Files` отображается список объектов (Иконка, Имя, Размер, File-ID, Путь).
 
   - **Оптимизация запросов:** Для оптимизации запросов используется поле 
   - При открытии папки выполняется запрос `PROPFIND` с `Depth: 1` для получения списка дочерних объектов.
   - В списке отображаются:
     - Иконка (папка/файл).
     - Имя (с возможностью клика для открытия папки или просмотра файла).
     - Размер (для файлов и паппок).
     - File-ID.
     - Путь (читаемый).
     - `last_sync_token`, которое хранит CTAG/ETAG сервера. Это позволяет проверять изменения в папках и файлах без необходимости выполнения полного запроса.

   - **Защита расширений:** При переименовании файлов система сравнивает расширения. Если пользователь изменил расширение вручную, оно игнорируется, и сохраняется оригинальное расширение из метаданных Nextcloud.
   - **Хлебные крошки:** Реализованы через расчетное поле `path_readable`, базирующееся на иерархии `parent_file_id`.

---

## III. Создание папок для моделей

1. Для каждой модели, поддерживающей хранение файлов, создается папка в корне `Odoo Docs`.
2. **Исключение:** Для `dino_project.py` папки верхнего уровня создаются на основе категорий (`dino.project.category`) — например, "Расходы", "Доходы".
3. **Связь через `nextcloud.root.map`:**
   - Хранит соответствие: `Имя модели + ID записи` <-> `Folder ID + Path`.
   - Позволяет переименовывать папки категорий без потери связи с записями в Odoo.

---

## IV. Иерархия папок проектов (dino_project.py)

1. **Структура пути:**
   `[Категория] / [Головой год] рік / [Год-Месяц Название] / [Дата Имя_проекта [ID]]`
   *Пример: "Расходы/2026 рік/2026-01 січень/2026-01-18 Закупка метиза [45]"*
2. **JSON-цепочка ID:**
   Связь проекта с Nextcloud фиксируется в формате JSON-массива ID всех уровней: `{"cat_id", "year_id", "month_id", "project_id"}`.
3. **Логика перемещения:**
   - При изменении даты проекта Odoo проверяет, изменился ли год или месяц.
   - Если изменился, выполняется команда `MOVE` для папки проекта в новую ветку дерева.
   - Если ветки (год или месяц) не существует, она создается "на лету" с сохранением новых ID в цепочку.
   - **Исключение дублей:** Поиск каждого сегмента пути перед созданием выполняется строго по ID из JSON-цепочки.

---

## V. Загрузка и синхронизация

1. **Загрузка:** Файлы, загруженные через чаттер или вкладку Nextcloud в Odoo, физически передаются в папку проекта на сервере.
2. **Обратная связь:**
   - Файлы, добавленные напрямую в Nextcloud, подтягиваются в Odoo при открытии вкладки проекта или по CRON.
   - Каждому файлу присваивается уникальный `file_id`.
3. **Парсинг:** (Реализовано) Загруженные файлы передаются ИИ-агенту для парсинка в JSON-шаблон. На основани полученноого JSON система формирует учетный документ.

---

## VI. Технический стек реализации

 Создание структуры: Чтобы гарантировать целостность структуры при первой загрузке, используйте заголовок X-NC-WebDAV-AutoMkcol: 1. Он заставляет сервер автоматически создавать всю цепочку недостающих родительских папок, что исключает ошибки при создании глубоко вложенных директорий


---

## VII. Список функций раздела Nextcloud

---

## VIII. Реализация мастер-копии

### Структура таблиц
Для реализации мастер-копии используется классическая иерархическая модель Odoo. В модели `nextcloud.file` (или аналогичной) должны быть следующие обязательные поля:

- `name` (String) — имя папки/файла.
- `parent_id` (Many2one к самой себе) — ссылка на родительскую папку.
- `nc_id` (Char/Integer) — наш «золотой» системный ID из Nextcloud. Это уникальный ключ (index=True).
- `path` (Char) — актуальный путь (для отображения и хлебных крошек).
- `type` (Selection) — 'folder' или 'file'.
- `is_root` (Boolean) — флаг для папки "Odoo Docs".

### Первичная синхронизация
При нажатии кнопки «Connect & Sync» система выполняет рекурсивный `PROPFIND` (Depth 1) по дереву папок. Каждому найденному `oc:id` в Nextcloud она сопоставляет запись в Odoo. Если записи нет — создается новая, если есть — обновляется путь.

---

## IX. Ограничение прав пользователей

### Что блокируем
Пользователь — это «турист». Ему запрещено:
- Создавать папки.
- Переименовывать папки.
- Перемещать папки.
- Удалять папки.

Пользователю разрешено:
- Просматривать структуру.
- Загружать файлы в существующие папки.
- Скачивать файлы.
- Удалять свои файлы (если это предусмотрено бизнес-логикой).

### Реализация прав
- **ACL:** Используются стандартные группы доступа Odoo (например, `group_nextcloud_admin` и `group_nextcloud_user`). У пользователя в `ir.model.access.csv` права на `write` и `unlink` в модели `nextcloud.file` будут ограничены.
- **Python:** В методах `create`, `write`, `unlink` модели `nextcloud.file` добавляется проверка `check_access_rights`. Если это папка (`type == 'folder'`) и пользователь не является администратором — выбрасывается `AccessError`.

---

## X. Синхронизация

### Подтверждение наличия
Проверка наличия объекта выполняется только через системный шлюз по ID: `/remote.php/dav/dav-oc-id/{nc_id}`. Используется метод `PROPFIND` с `Depth: 0`. Это самый быстрый способ узнать, существует ли объект и где он сейчас находится.

### Частота
1. **Принудительно:** Кнопка «Sync Structure» в настройках позволяет инициировать синхронизацию вручную.
2. **По требованию:** Когда пользователь заходит в папку через проводник, Odoo может выполнить быстрый «чек» (Depth 1) этой конкретной папки, чтобы убедиться в актуальности данных. Это называется «ленивая» синхронизация.

---

## XI. Обработка ошибок (Фантомные записи)

### Ситуация
В базе Odoo запись существует, но в Nextcloud возвращается ошибка `404` (объект был удален вручную).

### Решение
Если при попытке доступа по ID сервер возвращает `404`, Odoo помечает запись в базе как «Потерянная» (`state='lost'`) или удаляет её из проводника, чтобы пользователь не сталкивался с недоступным объектом. Администратору выводится лог с предупреждением: «Внимание, папка [Имя] была удалена в облаке напрямую».
