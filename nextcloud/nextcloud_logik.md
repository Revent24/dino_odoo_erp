# Логика работы раздела Nextcloud

## I. Подключение к Nextcloud

Параметры подключения указываются в записи модели `nextcloud.client`:

1. **Основные параметры:**
   - `url`: URL сервера Nextcloud (поле `Base URL`).
   - `username`: Имя пользователя.
   - `password`: Пароль пользователя.
   - `root_folder_id`: Уникальный системный ID корневой папки (поле `Nextcloud Folder ID`).
   - `root_folder_path`: Текущий путь к корневой папке (поле `Actual Path`).
   - `last_sync_token`: (Дополнение) CTAG/ETAG сервера для оптимизации запросов.

2. **Логика работы:**
   - **Первичный запуск:** Если `root_folder_id` пуст, создается папка `Odoo Docs`, извлекается её системный `fileid` и записывается в базу.
   - **Верификация:** При наличии `root_folder_id` система выполняет точечный запрос пути по этому ID.
   - **Автоматическое исправление:** Если путь на сервере изменился (папку переместили вручную), поле `root_folder_path` обновляется автоматически. Если папка удалена — создается новая `Odoo Docs` с регистрацией нового ID.

3. **Технические дополнения:**
   - Добавить универсальный метод `_get_full_url(self, path=None, file_id=None)` для разделения доступа:
     * Если есть `file_id`, использовать путь `/remote.php/dav/dav-oc-id/{file_id}`.
     * Если есть `path`, использовать `/remote.php/dav/files/{login}/{path}`.
   - Добавить метод `find_in_folder(self, parent_id, child_name)`, который через PROPFIND Depth: 1 ищет объект по имени внутри папки-родителя и возвращает его ID.
   - Добавить метод `ensure_path_step(self, parent_id, segment_name)`, который проверяет наличие сегмента и создает его (MKCOL) только при отсутствии.

---

## II. Список файлов и папок (Проводник)

1. **Отображение содержимого:**
   - При клике на меню `Files` отображается список объектов (Иконка, Имя, Размер, File-ID, Путь).
   - Все объекты синхронизированы с моделью `nextcloud.file`.
   - **Дополнение:** В модель `nextcloud.file` введено поле `parent_file_id` для построения дерева папок внутри Odoo без повторных запросов к API.

2. **Менеджмент имен:**
   - При переименовании записи в Odoo отправляется команда `MOVE` на Nextcloud.
   - **Защита расширений:** При переименовании файлов система сравнивает расширения. Если пользователь изменил расширение вручную, оно игнорируется, и сохраняется оригинальное расширение из метаданных Nextcloud.
   - **Хлебные крошки:** Реализованы через расчетное поле `path_readable`, базирующееся на иерархии `parent_file_id`.

---

## III. Создание папок для моделей

1. Для каждой модели, поддерживающей хранение файлов, создается папка в корне `Odoo Docs`.
2. **Исключение:** Для `dino_project.py` папки верхнего уровня создаются на основе категорий (`dino.project.category`) — например, "Расходы", "Доходы".
3. **Связь через `nextcloud.root.map`:**
   - Хранит соответствие: `Имя модели + ID записи` <-> `Folder ID + Path`.
   - Позволяет переименовывать папки категорий без потери связи с записями в Odoo.

---

## IV. Иерархия папок проектов (dino_project.py)

1. **Структура пути:**
   `[Категория] / [Головой год] рік / [Год-Месяц Название] / [Дата Имя_проекта [ID]]`
   *Пример: "Расходы/2026 рік/2026-01 січень/2026-01-18 Закупка метиза [45]"*
2. **JSON-цепочка ID:**
   Связь проекта с Nextcloud фиксируется в формате JSON-массива ID всех уровней: `{"cat_id", "year_id", "month_id", "project_id"}`.
3. **Логика перемещения:**
   - При изменении даты проекта Odoo проверяет, изменился ли год или месяц.
   - Если изменился, выполняется команда `MOVE` для папки проекта в новую ветку дерева.
   - Если ветки (год или месяц) не существует, она создается "на лету" с сохранением новых ID в цепочку.
   - **Исключение дублей:** Поиск каждого сегмента пути перед созданием выполняется строго по ID из JSON-цепочки.

---

## V. Загрузка и синхронизация

1. **Загрузка:** Файлы, загруженные через чаттер или вкладку Nextcloud в Odoo, физически передаются в папку проекта на сервере.
2. **Двусторонняя связь:**
   - Файлы, добавленные напрямую в Nextcloud, подтягиваются в Odoo при открытии вкладки проекта.
   - Каждому файлу присваивается уникальный `file_id`.
3. **Парсинг:** (Реализовано) Загруженные файлы передаются ИИ-агенту для формирования учетных документов.

---

## VI. Технический стек реализации

- **Поиск по ID:** Метод `PROPFIND` с фильтром `oc:id`.
- **Перемещение/Переименование:** Метод `MOVE` с заголовком `Destination`.
- **Создание:** Метод `MKCOL`.
- **Оптимизация:** Использование Redis для кэширования блокировок и CTAG для проверки изменений в папках.

---

## VII. Список функций раздела Nextcloud

### Модуль `models/nextcloud_client.py`:
1. **_get_connector(self)**: Получение соединения с Nextcloud.
2. **set_root_folder_id(self)**: Установка ID корневой папки.
3. **action_test_connection(self)**: Тестирование соединения с сервером Nextcloud.
4. **action_edit_connection(self)**: Редактирование настроек соединения.
5. **action_reset_id(self)**: Сброс ID корневой папки.

### Модуль `models/nextcloud_file.py`:
6. **action_main_menu_open(self)**: Открытие главного меню.
7. **name_get(self)**: Получение имени записи.
8. **_compute_icon_html(self)**: Вычисление HTML-иконки.
9. **_compute_path_readable(self)**: Вычисление читаемого пути.
10. **write(self, vals)**: Переопределение метода записи.
11. **_get_clean_path(self, path_str)**: Очистка пути.
12. **_resolve_actual_path(self)**: Проверка актуальности пути по ID.
13. **action_open_folder(self)**: Открытие папки.
14. **action_view_form(self)**: Открытие формы.
15. **_sync_folder_contents(self)**: Синхронизация содержимого папки.
16. **action_sync_current_folder(self)**: Синхронизация текущей папки.
17. **action_create_folder_wizard(self)**: Создание папки через мастер.
18. **action_upload_file_wizard(self)**: Загрузка файла через мастер.

### Модуль `tools/nextcloud_api.py`:
19. **__init__(self, url, login, password)**: Инициализация соединения с Nextcloud.
20. **_do_request(self, method, path, headers=None, data=None)**: Выполнение HTTP-запроса.
21. **get_object_data(self, path=None, file_id=None)**: Получение данных объекта через PROPFIND.

### Модуль `mixins/nextcloud_flat_mixin.py`:
31. **action_ensure_nc_folder(self)**: Убедиться в существовании папки Nextcloud.

### Модуль `mixins/nextcloud_base_mixin.py`:
32. **_get_nc_client(self)**: Получение клиента Nextcloud.
33. **_create_nc_record(self, client, name, nc_id, path, parent_id=False)**: Создание записи Nextcloud.
34. **_get_nc_connector(self)**: Получение соединения с Nextcloud.
35. **_update_nc_path(self)**: Обновление пути в Nextcloud.

### Модуль `tools/nextcloud_xml_utils.py`:
36. **get_propfind_body()**: Генерация тела запроса PROPFIND.

Найденные дублирующие функции:
_get_connector (models/nextcloud_client.py) и _get_nc_connector (mixins/nextcloud_base_mixin.py):

Обе функции возвращают экземпляр соединения с Nextcloud. Разница в том, что _get_connector работает с текущей записью, а _get_nc_connector ищет активный клиент в базе данных. Возможно, их можно объединить, чтобы избежать дублирования.

Рекомендации:
Объединить или уточнить назначение _get_connector и _get_nc_connector.
