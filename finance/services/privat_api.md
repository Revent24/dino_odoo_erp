Взаємодія з API

> Примечание: функциональность импорта транзакций отключена в текущей версии; поддерживается только импорт балансов.


Усі запити повинні містити обов’язкові поля в header:

User-Agent – клієнтський додаток;
token – отриманий із налаштувань token;
Content-Type – application/json;charset=cp1251.
Підтримувані кодування utf8 і cp1251. Якщо charset не зазначено, кодування за замовчуванням cp1251.


Отримання балансів і транзакцій за рахунками

Запити надсилаються за допомогою методу GET.


Отримання серверних дат

https://acp.privatbank.ua/api/statements/settings

Приклад відповіді

{

  "status": "SUCCESS",

  "type": "settings",

  "settings": {

    "phase": "WRK",

    "dates_without_oper_day": // дні без опер. днів

      "01.01.2018 00:00:00",

      "30.12.2018 00:00:00",

      "31.12.2018 00:00:00",

      "01.01.2019 00:00:00",

      "29.12.2019 00:00:00",

      "30.12.2019 00:00:00",

      "31.12.2019 00:00:00",

      "01.01.2020 00:00:00"

    ],

    "today": "30.03.2020 00:00:00", // дата поточного опер. дня (проміжна виписка)

    "lastday": "29.03.2020 00:00:00", // дата минулого опер. дня (проміжна виписка)

    "work_balance": "N", // чи проходять регламент завдання, N – можна робити запити, Y – запити не робити

    "server_date_time": "30.03.2020 12:03:51",

    "date_final_statement": "28.03.2020 00:00:00" // дата, включно з якої є підсумкова виписка

  }

}

Якщо значення phase відмінне від WRK, то в цей період запити до API можуть повертатися з помилками.



За інтервал дат

https://acp.privatbank.ua/api/statements/balance - для отримання балансів

https://acp.privatbank.ua/api/statements/transactions - для отримання транзакцій

?acc=номер рахунку

&startDate=ДД-ММ-ГГГГ - дата початку (обов’язковий параметр)

&endDate=ДД-ММ-ГГГГ - дата закінчення (необов’язковий параметр)

&followId=id наступної пачки з відповіді (необов’язковий параметр)

&limit=кількість записів у пачці (за замовчуванням 20), максимальне значення - 500, рекомендується використовувати не більше 100


Отримати проміжні дані – з lastday по today

https://acp.privatbank.ua/api/statements/balance(або transactions)/interim

?acc=номерРахунку

&followId=id наступної пачки з відповіді (необов'язковий параметр)

&limit=кількість записів у пачці (за замовчуванням 20), максимальне значення - 500, рекомендується використовувати не більше 100


Отримати дані за останній підсумковий день:

https://acp.privatbank.ua/api/statements/balance(или transactions)/final

?acc=номер рахунку

&followId=id наступної пачки з відповіді (необов’язковий параметр)

&limit=кількість записів у пачці (за замовчуванням 20), максимальне значення - 500, рекомендується використовувати не більше 100


Якщо номер рахунку не зазначено (немає параметра acc= і значення), дані будуть сформовані за всіма активними рахунками.

Якщо у відповіді параметр exist_next_page: true, значення з next_page_id потрібно підставити в наступний запит у параметр followId для отримання наступної пачки.

Приклад відповіді з балансами

{

  "status": "SUCCESS", // ознака успішності відповіді

  "type": "balances", // тип відповіді

  "exist_next_page": true, // ознака наявності наступної пачки

  "next_page_id": "26101050000888", // ідентифікатор наступної пачки  (підставляється у followId наступного запиту)

  "balances": [ // масив об’єктів із балансами

    {

      "acc": "UA943052990000026100050001037", // номер рахунку

      "currency": "UAH", // валюта

      "balanceIn": "0.00", // залишок на рахунку вхідний

      "balanceInEq": "0.00", // залишок на рахунку вхідний (екв. у нац. валюті)

      "balanceOut": "0.00", // залишок на рахунку вихідний

      "balanceOutEq": "0.00", // залишок на рахунку вихідний (екв. у нац. валюті)

      "turnoverDebt": "0.00", // оборот, дебет

      "turnoverDebtEq": "0.00", // оборот, дебет (екв. у нац. валюті)

      "turnoverCred": "0.00", // оборот, кредит

      "turnoverCredEq": "0.00", // оборот, кредит (екв. у нац. валюті)

      "bgfIBrnm": " ", // бранч, що залучив контрагента

      "brnm": "DNH0", // бранч рахунку

      "dpd": "09.03.2020 00:00:00", // дата останнього руху за рахунком

      "nameACC": "Програмiсти та Ko МСБ-ТЕСТ ТОВ", // найменування рахунку

      "state": "l",

      "atp": "D",

      "flmn": "DN",

      "date_open_acc_reg": "28.12.2016 00:00:00",

      "date_open_acc_sys": "28.12.2016 00:00:00",

      "date_close_acc": "01.01.1900 00:00:00",

      "is_final_bal": true

    },{...}

]}


Приклад відповіді з транзакціями

{

  "status": "SUCCESS", // ознака успішності відповіді

  "type": "transactions", // тип відповіді

  "exist_next_page": true, // ознака наявності наступної пачки

  "next_page_id": "620699370_online", // ідентифікатор наступної пачки (підставляється у followId наступного запиту)

  "transactions": [ // масив об’єктів із транзакціями

    {

      "AUT_MY_CRF": "31451288", // ЄДРПОУ одержувача

      "AUT_MY_MFO": "305299", // МФО одержувача

      "AUT_MY_ACC": "26184050001514", // рахунок одержувача

      "AUT_MY_NAM": "Програмiсти та Ko МСБ-ТЕСТ ТОВ", // назва одержувача

      "AUT_MY_MFO_NAME": "АТ КБ \"ПРИВАТБАНК\"", // банк одержувача

      "AUT_MY_MFO_CITY": "Київ", // назва міста банку

      "AUT_CNTR_CRF": "14360570", // ЄДРПОУ контрагента

      "AUT_CNTR_MFO": "305299", // МФО контрагента

      "AUT_CNTR_ACC": "70214924104032", // рахунок контрагента

      "AUT_CNTR_NAM": "ПРОЦ ВИТР ЗА СТРОК КОШТ СУБ(UAH)", // назва контрагента

      "AUT_CNTR_MFO_NAME": "АТ КБ \"ПРИВАТБАНК\"", // назва банку контрагента

      "AUT_CNTR_MFO_CITY": "Київ", // назва міста банку

      "CCY": "UAH", // валюта

      "FL_REAL": "r", // ознака реальності проведення (r,i)

      "PR_PR": "r", // стан p - проводиться, t - сторнована, r - проведена, n - забракована

      "DOC_TYP": "m", // тип пл. документа

      "NUM_DOC": "K0108B1WKX", // номер документа

      "DAT_KL": "07.01.2020", // клієнтська дата

      "DAT_OD": "07.01.2020", // дата валютування

      "OSND": "Нарахування вiдсоткiв згiдно депозитного договору N...", // підстава  платежу

      "SUM": "0.01", // сума

      "SUM_E": "0.01", // сума в національній валюті (грн)

      "REF": "DNCHK0108B1WKX", // референс проведення

      "REFN": "1", // № з/п всередині проведення

      "TIM_P": "02:58", // час проведення

      "DATE_TIME_DAT_OD_TIM_P": "07.01.2020 02:58:00",

      "ID": "557091731", // ID транзакції

      "TRANTYPE": "C", // тип транзакції дебет/кредит (D, C)

      "DLR": "J63DNDSM0XHY5", // референс платежу сервісу, через який створювали платіж (payment_pack_ref - у разі створення платежу через АPI «Автоклієнт»)

      "TECHNICAL_TRANSACTION_ID": "557091731_online"

            }, {...}

]}

Для виконання вимог НБУ, у відповіді можуть бути також додаткові поля, які відносяться до кінцевого платника/отримувача:


"UETR":"b23aeadc-1ab7-4c34-a005-0f005a059948", // ідентифікатор тразакції

"ULTMT":"N", // тип заповненості реквізитів

"PAYER_ULTMT_NCEO":"", // ЄДРПОУ кінцевого платника

"PAYER_ULTMT_DOCUMENT":"", // серія, номер паспорту кінцевого платника

"PAYER_ULTMT_NAME":"", // назва кінцевого платника

"PAYER_ULTMT_COUNTRY_CODE":"", // код країни нерезидента кінцевого платника

"RECIPIENT_ULTMT_NCEO":"", // ЄДРПОУ кінцевого отримувача

"RECIPIENT_ULTMT_DOCUMENT":"", // серія, номер паспорту кінцевого отримувача

"RECIPIENT_ULTMT_NAME":"", // назва кінцевого отримувача

"RECIPIENT_ULTMT_COUNTRY_CODE":"" // код країни нерезидента кінцевого отримувача

Для податкових платежів також додані нові поля для структурованого призначення платежу:

"STRUCT_CODE":”101”, // код виду сплати
"STRUCT_TYPE":”22080000”, // код бюджетної класифікації

"STRUCT_CATEGORY":”Довільний текст” // Інформація про податкове повідомлення (рішення)

Для ідентифікації унікальності платіжних інструкцій використовуйте конкатенацію полів REF+REFN

---

## Відповідність реалізації (короткий огляд)
Нижче — зведення відповідності між документацією та тим, що вже реалізовано в коді, а також список необхідних доробок.

### Реалізовано в коді ✅
- `PrivatClient.get_api_settings()` — відповідає `/statements/settings`.
- `PrivatClient.fetch_balances_for_all_accounts()` — балансні дані: використовується `acc` як `external_id` у `import_accounts()`.
- `PrivatClient.fetch_transactions_page()` та `fetch_transactions_iter()` — пагінація через `exist_next_page` / `next_page_id` підтримується.
- CP1251 fallback при парсингу відповіді та `request_delay` throttle — є у клієнті.
- `import_accounts()` — створення/оновлення рахунків з `acc` fallback; повертає рекордсет оброблених рахунків.

### Невирішені / потребують доробки ⚠️
- `privat_service.import_transactions()` має ітератор сторінок, але всередині обробка транзакції не реалізована (в коді стоїть заглушка `pass`). Потрібно:
  - робити дедуплікацію по `TECHNICAL_TRANSACTION_ID` (фолбек `REF+REFN` / `ID`),
  - створювати/оновлювати записи через `dino.bank.transaction.create_from_api(account.external_id, payload)` або еквівалент,
  - інкрементувати лічильники `created/updated/skipped`,
  - оновлювати `account.last_import_date` по max(datetime) оброблених транзакцій.
- Якщо `account is None`, функція повинна пройти по всіх рахунках банку (це очікують існуючі тести).
- Розширити тести: покриття пагінації, створення транзакцій, дедуплікації та оновлення `last_import_date`.

---

## Рекомендації по пріоритетам
1. **Високий**: реалізувати обробку транзакції + дедуплікацію + оновлення `last_import_date` + тести.
2. **Середній**: додати параметр `max_pages`/`max_records_per_run` для захисту UI від довгих синків.
3. **Низький**: покращення логів (номер сторінки, followId, кількість транзакцій) і UX (повідомлення по завершенні).

---

_При необхідності можу одразу реалізувати пункти 1–2 і додати тести; скажіть, чи робимо це зараз._ 