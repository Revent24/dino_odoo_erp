# Руководство по использованию Seafile

## Обзор Seafile
Seafile — это защищённая система для совместной работы и синхронизации файлов, позиционируемая как альтернатива облачным хранилищам.

### Основные возможности
- Интеграция с ONLYOFFICE для редактирования документов
- Использование Elasticsearch для продвинутого полнотекстового поиска
- Методы безопасности и шифрования
- Функции на базе искусственного интеллекта, такие как распознавание лиц и текста (OCR)

### Редакции
- **Community Edition**: Бесплатная версия с базовыми функциями
- **Professional Edition**: Платная версия с расширенными функциями, такими как Metadata Server

---

## Интеграция с Odoo

### Менеджер файлов
Odoo может выступать в роли интерфейса управления хранилищем Seafile.

#### Основные функции
- Навигация по дереву папок
- Загрузка и скачивание файлов
- Создание, переименование и удаление папок
- Привязка к бизнес-логике Odoo

#### Метаданные
- В версии Professional можно хранить ID записей Odoo в метаданных Seafile для надёжной связи.
- В версии Community связь осуществляется через сохранение repo_id и path в базе данных Odoo.

#### Поиск
- **Community Edition**: Базовый поиск по именам файлов
- **Professional Edition**: Полнотекстовый поиск внутри документов

---

## Интеграция офисных пакетов

### Поддерживаемые решения
- OnlyOffice
- Collabora Online
- Microsoft Office Online Server (только в версии Pro)

### Основные возможности
- Совместное редактирование в реальном времени
- Умные ссылки для редактирования в браузере
- Контроль версий и блокировка файлов

---

## Поисковые движки

### Доступные варианты
- **SeaSearch**: Лёгкий движок на языке Go, подходит для систем с низкими ресурсами
- **Elasticsearch**: Мощный движок на Java, требует больше ресурсов

### Рекомендации
- SeaSearch подходит для малоресурсных систем.
- Elasticsearch лучше для полнотекстового поиска в версии Pro.

---

## Предпросмотр файлов

### Поддерживаемые форматы
- PDF
- Изображения
- Видео
- Аудио

### Офисные файлы
Требуется интеграция с OnlyOffice или Collabora Online.

---

## Python-библиотеки для интеграции

### Основные
- **seafileapi**: Официальный Python SDK для работы с Seafile
- **requests**: Для выполнения HTTP-запросов

### Дополнительные
- **Pillow** и **OpenCV**: Для обработки изображений
- **NumPy** и **Pandas**: Для анализа данных
- **python-redis**: Для распределённого индексирования

---

## Работа с Seafile через Python

Для работы с Seafile через Python наиболее удобно использовать официальную библиотеку **`seafileapi`** (её форк `seafileapi2`) или напрямую обращаться к **REST API** с помощью библиотеки `requests`. Ниже приведены примеры реализации основных задач.

### 1. Подключение и базовые операции (SDK)
Этот пример показывает, как авторизоваться под учетной записью администратора или пользователя, создать библиотеку и загрузить в неё файл.

```python
from seafileapi import SeafileAPI

# Инициализация клиента
server_url = "https://your-seafile.com"
username = "admin@email.com"
password = "password"

client = SeafileAPI(username, password, server_url)
client.auth() # Аутентификация на сервере

# Просмотр всех доступных аккаунтов (для админа)
accounts = client.admin.list_accounts()

# Создание новой библиотеки
new_repo = client.repos.create_repo('Project_Files')

# Загрузка файла в корень библиотеки
# ВАЖНО: Используйте 'rb' для бинарных файлов (PDF, изображения), чтобы избежать ошибок
new_repo.upload_file('/', '/local/path/to/document.pdf')
```

### 2. Подключение к конкретной библиотеке по токену
Если у вас уже есть **Repo API-Token**, вы можете работать с библиотекой напрямую, не передавая пароль пользователя.

```python
from seafileapi import Repo

api_token = 'ваш_токен_библиотеки'
server_url = "https://your-seafile.com"

# Работа с конкретной библиотекой по её токену
api_repo = Repo(api_token, server_url)
api_repo.auth()

# Получение информации о размере и количестве файлов
details = api_repo.get_repo_details()
print(f"Библиотека: {details['repo_name']}, Файлов: {details['file_count']}")
```

### 3. Рекурсивный обход всех папок
Поскольку в Seafile нет одного запроса для получения всех файлов во всех подпапках сразу, используется рекурсивная функция.

```python
def get_all_files(repo, path='/'):
    items = repo.list_dir(path) # Получаем список объектов в папке
    
    for item in items:
        if item['type'] == 'file':
            print(f"Файл: {item['name']}, Путь: {path}, Размер: {item['size']} байт")
        elif item['type'] == 'dir':
            # Если это папка, вызываем функцию повторно для вложенного пути
            new_path = (path + '/' + item['name']).replace('//', '/')
            get_all_files(repo, new_path)

# Запуск обхода с корня
get_all_files(api_repo)
```

### 4. Потоковая загрузка больших файлов (Requests)
Для загрузки «тяжелых» файлов рекомендуется использовать потоковую передачу данных, чтобы не загружать весь файл в оперативную память сервера.

```python
import requests

# 1. Получаем ссылку для загрузки (upload_link)
# 2. Выполняем POST запрос с открытым файлом
upload_url = "ссылка_полученная_через_API"
token = "ваш_токен"

with open('large-video.mp4', 'rb') as f:
    files = {'file': f}
    data = {'filename': 'video.mp4', 'parent_dir': '/'}
    headers = {'Authorization': f'Token {token}'}
    
    response = requests.post(upload_url, data=data, files=files, headers=headers)
```

### Технические примечания:
* **Зависимости**: Для работы скриптов требуется **Python 3.x** и установленные пакеты `requests` и `python-seafile-api` (или `seafileapi2`).
* **Безопасность**: При работе с зашифрованными библиотеками через API их необходимо сначала «разблокировать» (decrypt) с помощью пароля, иначе операции скачивания или просмотра будут недоступны.
* **Лимиты**: При массовом создании записей или частом опросе API сервер может вернуть ошибку **429 (Too Many Requests)**. В этом случае рекомендуется добавлять небольшие паузы (`time.sleep`) или оптимизировать запросы.

---

## Работа с Seafile и метаданными через Python

Для работы с Seafile и его метаданными через Python вам потребуется основной набор библиотек для взаимодействия с API.

### 1. Основные библиотеки и их установка

Согласно источникам, для работы с Seafile в среде Python наиболее актуальны следующие пакеты:

* **`seafileapi2`**: Это пакет официального Python SDK для Seafile.
  * *Установка:* `pip install seafileapi2`.
* **`python-seafile-api`**: Это форк оригинальной библиотеки с поддержкой дополнительных функций. Он предоставляет клиентский интерфейс для Web API.
  * *Установка:* `pip install python-seafile-api`.
* **`requests`**: Фундаментальная библиотека для выполнения HTTP-запросов, на которой базируются вышеуказанные клиенты. Она необходима для прямой работы с эндпоинтами API, такими как загрузка больших файлов или работа с метаданными.
* **`ebrains-drive`**: Альтернативный клиент, который упрощает использование Seafile REST API за счет создания специальных вспомогательных функций.
  * *Установка:* `pip install ebrains-drive`.

### 2. Работа с метаданными (Metadata Records)

Если вы собираетесь работать именно с **Metadata Records** (записями метаданных), вам важно учитывать следующее:

* **API v2.1**: Функции управления метаданными (Metadata Operations) доступны через Web API версии 2.1.
* **Доступные операции**: Через API вы сможете выполнять команды `List metadata records` (получение списка записей), `Update metadata records` (обновление данных) и `Add column` (добавление новых колонок для структурированных данных).
* **Использование токенов**: Работа с метаданными поддерживается через **Repo API-Token** (токен библиотеки), что позволяет выполнять операции `via-repo-token`.

### 3. Важные требования со стороны сервера

Работа с метаданными в Seafile имеет технические нюансы, описанные в источниках:

* **Metadata Server**: Для управления метаданными на стороне сервера должен быть развернут и включен соответствующий компонент — **Metadata Server**.
* **Professional Edition**: Полноценное управление метаданными (Metadata Management), включая расширенные свойства файлов, иерархические теги и представления вроде Kanban, является функцией **Professional Edition** или облачной версии **Plus Edition**. В бесплатной Community Edition возможности работы со структурированными метаданными ограничены базовым поиском по именам файлов.
* **Шифрование**: Учтите, что если библиотека зашифрована, сервер не сможет индексировать её содержимое, хотя некоторые метаданные могут оставаться доступными.

**Рекомендация:** Для интеграции с Odoo используйте `python-seafile-api` или прямые запросы через `requests` к API v2.1, так как это обеспечит наиболее гибкий доступ к полям метаданных.

---

## Рекомендации по настройке

### Поисковый движок
- Настройки поиска находятся в файле `seafevents.conf`.
- Elasticsearch требует минимум 4 ГБ ОЗУ, SeaSearch — 2 ГБ.

### Офисные пакеты
- OnlyOffice и Collabora Online можно установить на тот же сервер, что и Seafile.
- Для безопасной связи используется JWT-секрет.

---

## Примечания
- Для связи с Odoo рекомендуется использовать repo_id и path.
- В версии Pro связь становится более надёжной благодаря Metadata Server.
- Для малоресурсных систем лучше использовать SeaSearch вместо Elasticsearch.